---
title: Enteropathogen antibody dynamics and force of infection among children in low-resource settings
subtitle: Supplementary Information File 1. Effect of interventions, bead lots, and season on enteropathogen antibody response.
output: 
  html_document:
    highlight: haddock
    theme: default
    code_folding: hide
    df_print: paged
    toc: yes
    toc_depth: '3'
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---

# Notebook summary

This notebook compares antibody measurements among children assigned to different treatment arms in the Asembo, Kenya household water filter trial and in the Kongwa, Tanzania annual azithromycin distribution trial. For additional details on the interventions and design, please see the main text and previously published articles related to the trials:

Morris, J. F., Murphy, J., Fagerli, K., Schneeberger, C., Jaron, P., Moke, F., Juma, J., Ochieng, J. B., Omore, R., Roellig, D., Xiao, L., Priest, J. W., Narayanan, J., Montgomery, J. M., Hill, V., Mintz, E., Ayers, T. L. & O’Reilly, C. E. A Randomized Controlled Trial to Assess the Impact of Ceramic Water Filters on Prevention of Diarrhea and Cryptosporidiosis in Infants and Young Children-Western Kenya, 2013. _Am. J. Trop. Med. Hyg._ 98, 1260–1268 (2018). https://www.ncbi.nlm.nih.gov/pubmed/29611500

Wilson, N., Goodhew, B., Mkocha, H., Joseph, K., Bandea, C., Black, C., Igietseme, J., Munoz, B., West, S. K., Lammie, P., Kasubi, M. & Martin, D. L. Evaluation of a Single Dose of Azithromycin for Trachoma in Low-Prevalence Communities. _Ophthalmic Epidemiol._ 26, 1–6 (2019). https://www.ncbi.nlm.nih.gov/pubmed/30543311

The results show that the interventions did not effect enteropathogen antibody response. Based on these results, we pooled data across treatment arms in all analyses.

The second section of this notebook stratifies the analyses from Tanzania in years 1 versus years 2-4. The Tanania study  used different bead lots in year 1 versus years 2-4 of the study. Different bead lots could theoretically have different antigen coupling efficiency, which could introduce differences in the MFI-bg measurements, since they are on an arbitrary scale that depends on how much antibody from the sample binds to the beads. Results of the stratified analyses show that the patterns observed were qualitatively and quantitatively similar for year 1 (n=902) versus years 2-4 (n=4,087). Owing to the much larger number of samples from later years, the results of this analysis also show that the pooled results match almost exactly the estimates from years 2-4.

The third section of this notebook examines the influence of rainy versus dry season in the Leogane, Haiti cohort (the only study with measurements that spanned dry and rainy seasons). The results suggest slightly higher IgG levels and seroprevalence for many pathogens during the wet season compared with the dry season. The increases are of small magnitude, however. For example, increases in seroprevalence associated with the wet season ranged from 1 to 4 percentage points.

# Script preamble
```{r preamble}
#-----------------------------
# preamble
#-----------------------------
library(here)
here::here()

# load packages
library(tidyverse)
library(tmleAb) # development package: devtools::install_github("ben-arnold/tmleAb")
library(mgcv)
library(knitr)
library(kableExtra)
  options(knitr.table.format = "html") 

# set up for parallel computing
library(foreach)
library(doParallel)
registerDoParallel(cores = detectCores() - 1)


# bright color blind palette:  https://personal.sron.nl/~pault/ 
cblack <- "#000004FF"
cblue <- "#3366AA"
cteal <- "#11AA99"
cgreen <- "#66AA55"
cchartr <- "#CCCC55"
cmagent <- "#992288"
cred <- "#EE3333"
corange <- "#EEA722"
cyellow <- "#FFEE33"
cgrey <- "#777777"

# safe color blind palette
# http://jfly.iam.u-tokyo.ac.jp/color/
# http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

```


# Asembo, Kenya Intervention Effects


## Load the data and format
```{r load data}
#-----------------------------
# load the formatted data
# with seropositivity indicators
# created with:
# asembo-enteric-ab-data-format.Rmd -->
# asembo-enteric-ab-distributions.Rmd
#-----------------------------
dl <- readRDS(here::here("data","asembo_analysis2.rds"))

# list the enteric antigens and make formatted labels for them
mbavars <- c("vsp3","vsp5","cp17","cp23","leca","salb","sald","p18","p39","etec","cholera")

mbalabs <- c("Giardia VSP-3","Giardia VSP-5","Cryptosporidium Cp17","Cryptosporidium Cp23","E. histolytica LecA","Salmonella LPS B","Salmonella LPS D","Campylobacter p18","Campylobacter p39","ETEC LT B subunit","Cholera toxin B subunit")
```

```{r composite antigens, warning=FALSE}
#-----------------------------
# create composite 
# seropositivity indicators
# that use information from
# multiple antigens
#-----------------------------

dgi <- dl %>% 
  filter(antigen %in% c("vsp3","vsp5")) %>%
  select(childid,time,tr,sex,age,agediff,pathogen,antigen,seropos) %>%
  spread(antigen,seropos) %>%
  mutate(seropos=ifelse(vsp3==1|vsp5==1,1,0),
         antigen="vsp3vsp5",
         antigenf="Giardia VSP-3 or VSP-5") %>%
  select(-vsp3,-vsp5)

dcr <- dl %>% 
  filter(antigen %in% c("cp17","cp23")) %>%
  select(childid,time,tr,sex,age,agediff,pathogen,antigen,seropos) %>%
  spread(antigen,seropos) %>%
  mutate(seropos=ifelse(cp17==1|cp23==1,1,0),
         antigen="cp17cp23",
         antigenf="Cryptosporidium Cp17 or Cp23") %>%
  select(-cp17,-cp23)

ds <- dl %>% 
  filter(antigen %in% c("salb","sald")) %>%
  select(childid,time,tr,sex,age,agediff,pathogen,antigen,seropos) %>%
  spread(antigen,seropos) %>%
  mutate(seropos=ifelse(salb==1|sald==1,1,0),
         antigen="salbsald",
         antigenf="Salmonella LPS groups B or D") %>%
  select(-salb,-sald)

dcp <- dl %>% 
  filter(antigen %in% c("p18","p39")) %>%
  select(childid,time,tr,sex,age,agediff,pathogen,antigen,seropos) %>%
  spread(antigen,seropos) %>%
  mutate(seropos=ifelse(p18==1|p39==1,1,0),
         antigen="p18p39",
         antigenf="Campylobacter p18 or p39") %>%
  select(-p18,-p39)



dlp <- bind_rows(dl,dgi,dcr,ds,dcp) %>%
  mutate(antigenf=factor(antigenf,
                         levels=c("Giardia VSP-3 or VSP-5",
                                  "Cryptosporidium Cp17 or Cp23",
                                  "E. histolytica LecA",
                                  "Salmonella LPS groups B or D",
                                  "ETEC LT B subunit",
                                  "Cholera toxin B subunit",
                                  "Campylobacter p18 or p39")) ) %>%
  filter(!is.na(antigenf)) %>%
  select(pathogen,antigen,antigenf,
         childid,time,tr,sex,age,agediff,
         mfi,logmfi,logmfidiff,
         roccut,mixcut,unexp,unexpcut,serocut,serocut_desc,
         posroc,posmix,posunex,seropos) %>%
  arrange(pathogen,antigenf,childid,time)

#-----------------------------
# create a dummy variable equal
# to 1 for all obs as a trick to
# get marginal predictions by
# age while still including REs
# for child
#-----------------------------
dlp <- dlp %>%
  mutate(dummy=1)
```

## Estimate curves in each treatment arm
```{r age-curve by arm }
#----------------------------------
# simulataneous CIs for GAMs
# estimated by resampling the 
# Baysian posterior estimates of
# the variance-covariance matrix
# assuming that it is multivariate normal
# the function below also estimates 
# the unconditional variance-covariance
# matrix, Vb=vcov(x,unconditional=TRUE), 
# which allows for undertainty in the actual
# estimated mean as well 
# (Marra & Wood 2012 Scandinavian Journal of Statistics, 
#  Vol. 39: 53–74, 2012, doi: 10.1111/j.1467-9469.2011.00760.x )
# simultaneous CIs provide much better coverage than pointwise CIs
# see: http://www.fromthebottomoftheheap.net/2016/12/15/simultaneous-interval-revisited/
#----------------------------------

gamCI <- function(m,newdata,nreps=10000) {
  require(mgcv)
  require(dplyr)
  Vb <- vcov(m,unconditional = TRUE)
  pred <- predict(m, newdata, se.fit = TRUE)
  fit <- pred$fit
  se.fit <- pred$se.fit
  BUdiff <- MASS::mvrnorm(n=nreps, mu = rep(0, nrow(Vb)), Sigma = Vb)
  Cg <- predict(m, newdata, type = "lpmatrix")
  simDev <- Cg %*% t(BUdiff)
  absDev <- abs(sweep(simDev, 1, se.fit, FUN = "/"))
  masd <- apply(absDev, 2L, max)
  crit <- quantile(masd, prob = 0.95, type = 8)
  pred <- data.frame(newdata,fit=pred$fit,se.fit=pred$se.fit)
  pred <- mutate(pred,
                 uprP = fit + (2 * se.fit),
                 lwrP = fit - (2 * se.fit),
                 uprS = fit + (crit * se.fit),
                 lwrS = fit - (crit * se.fit)
  )
  return(pred)
}


#-----------------------------
# fit cubic spline over age, separately for each 
# treatment arm and antigen
# estimate approximate simultaneous confidence intervals
# for the fits
# set the dummy to 0 to 
# zero out all of the random effects
# see posts on Stack Exchange for explanation:
# https://stats.stackexchange.com/questions/131106/predicting-with-random-effects-in-mgcv-gam/131116#131116
# https://stats.stackexchange.com/questions/189384/predicting-mean-smooth-in-gam-with-smooth-by-random-factor-interaction
#-----------------------------

library(mgcv)
pgamfits <- foreach(ab=levels(dlp$antigenf),.combine=rbind) %dopar% {
    pd <- filter(dlp, antigenf==ab)
    gfit <- mgcv::gam(seropos~s(age, bs="cr",by=tr)+s(childid,bs="re",by=dummy)+tr, data=pd,family="binomial")
    newd0 <- pd %>% mutate(dummy=0,tr="Cont")
    newd1 <- pd %>% mutate(dummy=0,tr="Int")
    gsci0 <- gamCI(m=gfit,newdata=newd0,nreps=1000)
    gsci1 <- gamCI(m=gfit,newdata=newd1,nreps=1000)
    gsci <- bind_rows(gsci0,gsci1) %>% mutate(antigenf=ab)
    return(gsci)
}

# use antilogit to get back to prevalence from the logit link
pgamfits <- pgamfits %>%
  mutate(fit  = 1/(1+exp(-fit)),
         uprP = 1/(1+exp(-uprP)),
         lwrP = 1/(1+exp(-lwrP)),
         uprS = 1/(1+exp(-uprS)),
         lwrS = 1/(1+exp(-lwrS))) %>%
  mutate(antigenf=factor(antigenf,levels=levels(dlp$antigenf)),
         tr=factor(tr,levels=c("Cont","Int"),labels=c("Control","Intervention"))
  )

```

## Estimate seroprevalence by treatment arm
Estimate overall mean seroprevalence by treatment arm and compare arms. Standard errors account for repeated measurements within child using the influence curve.

```{r tmle means,message=FALSE}
#-----------------------------
# estimate means by treatment
# arm and difference between
# arms using targeted maximum
# likelihood estimation
# get 95% CIs through the
# influence curve clustered
# on child ID
# adjust for age with GLM
#-----------------------------
tmlediffs <- foreach(ab=levels(dlp$antigenf),.combine=rbind) %dopar% {
    pd <- filter(dlp,antigenf==ab) %>% mutate(tr01=ifelse(tr=="Int",1,0))
    diffmu <- tmleAb(Y=pd$seropos,X=pd$tr01,W=pd$age,
                     id=pd$childid,SL.library=c("SL.glm"),
                     family="binomial")
    di <- data.frame(antigenf=ab,diff=diffmu$psi,lb=diffmu$lb,ub=diffmu$ub,p=diffmu$p)
    return(di)
  }

#-----------------------------
# report estimates in tables
#-----------------------------
knitr::kable(tmlediffs,digits=2,caption="Difference in seroprevalence (Intervention minus Control)")  %>%
  kable_styling(bootstrap_options = "striped",full_width = TRUE)

```

No evidence for lower enteric antibody seroprevalence due to intervention.

## Figure of seroprevlance curves

```{r age-seroprevalence figure, fig.width=9 , fig.height=10}
# bright color-blind palette defined in an earlier code chunk
pcols <- c(cblack,cteal)

ppcurve <- ggplot(data=pgamfits,aes(x=age,color=tr,fill=tr)) +
  # approximate simultaneous CI from spline fit
  geom_ribbon(aes(ymin=lwrS,ymax=uprS),alpha=0.2,color=NA) +
  # spline fit
  geom_line(aes(y=fit)) +
  # plot aesthetics
  facet_wrap(~antigenf,nrow=7,ncol=2) +
  scale_x_continuous(limits=c(4,17),breaks=seq(4,16,by=2))+
  scale_y_continuous(breaks=seq(0,1,by=0.2),labels=sprintf("%1.0f",seq(0,1,by=0.2)*100))+
  coord_cartesian(ylim=c(0,1))+
  labs(x="Age in months",y="Seroprevalence (%)") +
  scale_fill_manual(values=pcols) +
  scale_color_manual(values=pcols) +
  theme_minimal() +
  theme(legend.position = "right")

ppcurve

```

# Kongwa, Tanzania Intervention Effects

In Kongwa, Tanzania, antibody measurements were among children ages 1-9 years old. Without children <1, it was difficult to identify seropositivity cutoff values based on mixture models for any of the enteric pathogens (see main text). Therefore, there were only 3 pathogens (Giardia, Crypto, E. histolytica) where we could classify children as seropositive or seronegative becuase out-of-sample specimens were used to estimate cutoffs using an ROC curve. 
In light of this limitation, below we compare the intervention and control groups using mean log MFI values, which is a reasonable alternative in this situation ([Arnold et al. 2017](http://journals.plos.org/plosntds/article?id=10.1371/journal.pntd.0005616).

_Salmonella_ and _Campylobacter_ antibodies were not measured after the first year enrollment survey in 2012.  No clusters were treated at enrollment, therefore we cannot assess the effect of azithromycin treatment on these pathogens. Therefore, limit comparisons to years 2013-2015 to avoid any potential time trends, including those due to a change in bead lots from 2012 until the later years.

```{r load kongwa data}
#-----------------------------
# load the formatted data
# for enteric pathogens
# with seropositivity indicators
#-----------------------------
dl <- readRDS(here::here("data","kongwa_analysis2.rds"))

dl <- dl %>%
  filter(!antigen %in% c("salb","sald","p18","p39","pgp3")) %>%
  filter(!year %in% c(2012)) %>%
  mutate(antigenf=droplevels(antigenf),
         pathogen=droplevels(pathogen),
         tr=factor(ifelse(aztr==0,"Control","Intervention"),levels=c("Control","Intervention"))
  )
```


```{r kongwa composite antigens, include=FALSE,eval=FALSE}
#-----------------------------
# create composite 
# seropositivity indicators
# that use information from
# multiple antigens
#-----------------------------
dl <- dl %>%
  mutate(seropos=posroc)

dgi <- dl %>% 
  filter(antigen %in% c("vsp3","vsp5")) %>%
  select(svy,year,vilid,clusterid,id,aztr,age,pathogen,antigen,seropos) %>%
  spread(antigen,seropos) %>%
  mutate(seropos=ifelse(vsp3==1|vsp5==1,1,0),
         antigen="vsp3vsp5",
         antigenf="Giardia VSP-3 or VSP-5") %>%
  select(-vsp3,-vsp5)

dcr <- dl %>% 
  filter(antigen %in% c("cp17","cp23")) %>%
  select(svy,year,vilid,clusterid,id,aztr,age,pathogen,antigen,seropos) %>%
  spread(antigen,seropos) %>%
  mutate(seropos=ifelse(cp17==1|cp23==1,1,0),
         antigen="cp17cp23",
         antigenf="Cryptosporidium Cp17 or Cp23") %>%
  select(-cp17,-cp23)


dlp <- bind_rows(dl,dgi,dcr) %>%
  mutate(antigenf=factor(antigenf,
                         levels=c("Giardia VSP-3 or VSP-5",
                                  "Cryptosporidium Cp17 or Cp23",
                                  "E. histolytica LecA")) ) %>%
  filter(!is.na(antigenf)) %>%
  select(pathogen,antigen,antigenf,
         svy,year,vilid,clusterid,id,aztr,age,
         mfi,logmfi,
         roccut,mixcut,
         posroc,posmix,seropos) %>%
  arrange(pathogen,antigenf,svy,year,vilid,clusterid)


```


## Estimate curves in each treatment arm
```{r kongwa age-curve by arm }
#-----------------------------
# fit cubic spline over age
# estimate approximate simultaneous confidence intervals
# for the fits
# include random effects for
# cluster to account for repeated
# observations
#-----------------------------
gamfits <- foreach(ab=levels(dl$antigenf),.combine=rbind) %dopar% {
    pd <- filter(dl, antigenf==ab) %>%
      mutate(dummy=1)
    gfit <- mgcv::gam(logmfi~s(age, bs="cr",k=9,by=tr)+s(clusterid,bs="re",by=dummy)+tr ,data=pd,family="gaussian")
    newd0 <- pd %>% mutate(dummy=0,tr="Control")
    newd1 <- pd %>% mutate(dummy=0,tr="Intervention")
    gsci0 <- gamCI(m=gfit,newdata=newd0,nreps=1000)
    gsci1 <- gamCI(m=gfit,newdata=newd1,nreps=1000)
    gsci <- bind_rows(gsci0,gsci1) %>% mutate(antigenf=ab)
    return(gsci)
  }

gamfits <- gamfits %>%
  mutate(antigenf=factor(antigenf,levels=levels(dl$antigenf)),
         tr=factor(tr,levels=levels(dl$tr))
  )

```

## Estimate means by treatment arm
Estimate overall mean log MFI by treatment arm and compare arms. Standard errors account for repeated measurements within clusters using the influence curve.

```{r kongwa tmle means,message=FALSE}
#-----------------------------
# estimate means by treatment
# arm and difference between
# arms using targeted maximum
# likelihood estimation
# get 95% CIs through the
# influence curve clustered
# on child ID
# adjust for age with glm
#-----------------------------
ktmlemeans <- foreach(tri=levels(dl$tr),.combine=rbind) %:% 
  foreach(ab=levels(dl$antigenf),.combine=rbind) %dopar% {
    pd <- filter(dl,tr==tri & antigenf==ab)
    mu <- tmleAb(Y=pd$logmfi,id=pd$clusterid,W=select(pd,age),
                 SL.library=c("SL.glm"))
    di <- data.frame(tr=tri,antigenf=ab,mean=mu$psi,se=mu$se,lb=mu$lb,ub=mu$ub)
    return(di)
  }

ktmlediffs <- foreach(ab=levels(dl$antigenf),.combine=rbind) %dopar% {
    pd <- filter(dl,antigenf==ab) %>% mutate(tr01=ifelse(tr=="Control",0,1))
    diffmu <- tmleAb(Y=pd$logmfi,X=pd$tr01,W=select(pd,age),
                     id=pd$clusterid,SL.library=c("SL.glm"))
    di <- data.frame(antigenf=ab,diff=diffmu$psi,se=diffmu$se,lb=diffmu$lb,ub=diffmu$ub,p=diffmu$p)
    return(di)
  }

#-----------------------------
# report estimates in tables
#-----------------------------

# seroprevalence among intervention and control
knitr::kable(arrange(ktmlemeans,antigenf,tr),digits=2,caption="Mean MFI in the Intervention and Control groups")  %>%
  kable_styling(bootstrap_options = "striped",full_width = TRUE)

# difference between groups
knitr::kable(ktmlediffs,digits=2,caption="Difference in MFI (Intervention minus Control)")  %>%
  kable_styling(bootstrap_options = "striped",full_width = TRUE)

```
These results suggest that IgG values for _E. histolytica_ LecA were slightly _higher_ in intervention clusters than control clusters (difference = 0.25, 95% CI = 0.09, 0.42).  This is consistent with age dependent mean curves (below) that show the intervention clusters that received annual azithromycin distribution consistently had slightly higher mean LecA levels. 

Below, estimate the difference between arms in LecA seroprevalence, which suggests a higher seroprevalence in the intervention clusters that received annual azythromycin distribution (21% relative increase).

```{r kongwa leca seroprev, message=FALSE}
leca_serop <- foreach(tri=levels(dl$tr),.combine=rbind) %dopar% {
    pd <- filter(dl,tr==tri & antigenf=="E. histolytica LecA")
    mu <- tmleAb(Y=pd$posroc,id=pd$clusterid,W=select(pd,age),
                 SL.library=c("SL.glm"),family="binomial")
    di <- data.frame(tr=tri,antigenf="E. histolytica LecA", mean=mu$psi,se=mu$se,lb=mu$lb,ub=mu$ub)
    return(di)
}


pd <- dl %>%
  filter(antigenf=="E. histolytica LecA") %>%
  mutate(tr01=ifelse(tr=="Control",0,1))
leca_diff <- tmleAb(Y=pd$posroc,X=pd$tr01,W=select(pd,age),
                     id=pd$clusterid,SL.library=c("SL.glm"),
                    family="binomial")


```


## Figure of mean curves

```{r kongwa age-mean figure, fig.width=9, fig.height=10}
# bright color-blind palette defined in an earlier code chunk
pcols <- c(cblack,cteal)

mucurve <- ggplot(data=gamfits,aes(x=age,color=tr,fill=tr)) +
  # approximate simultaneous CI from spline fit
  geom_ribbon(aes(ymin=lwrS,ymax=uprS),alpha=0.2,color=NA) +
  # spline fit
  geom_line(aes(y=fit)) +
  # plot aesthetics
  facet_wrap(~antigenf,nrow=7,ncol=2) +
  scale_x_continuous(limits=c(1,9),breaks=1:9)+
  scale_y_continuous(breaks=seq(0,4,by=1))+
  coord_cartesian(ylim=c(0,4.5))+
  labs(x="Age in years",y="log10 Luminex Response (MFI-bg)") +
  scale_fill_manual(values=pcols) +
  scale_color_manual(values=pcols) +
  theme_minimal() +
  theme(legend.position = "right")

mucurve

```


# Kongwa, Tanzania Bead Lot Effects

## Load and format data
```{r data format bead comp}
#-----------------------------
# load the formatted data
# created with 
# asembo-enteric-ab-data-format.Rmd
#-----------------------------
dl <- readRDS(here::here("data","kongwa_analysis.rds"))

# list the enteric antigens and formatted labels for them
mbavars <- c("vsp3","vsp5","cp17","cp23","leca","salb","sald","etec","cholera","p18","p39","pgp3")

mbalabs <- c("Giardia VSP-3","Giardia VSP-5","Cryptosporidium Cp17","Cryptosporidium Cp23","E. histolytica LecA","Salmonella LPS group B","Salmonella LPS group D","ETEC LT B subunit","Cholera toxin B subunit","Campylobacter p18","Campylobacter p39","C. trachomatis pgp3")

dl <- dl %>%
  mutate(antigen=as.character(antigen))

#-----------------------------
# subset to antigens measured
# in all years
#-----------------------------
dl <- dl %>%
  filter(antigen %in% c("vsp3","vsp5","cp17","cp23","leca","etec"))

#-----------------------------
# create a stratification
# variable for bead set
#-----------------------------
dl <- dl %>%
  mutate(beadset = factor(ifelse(year==2012,"Year 1","Years 2-4")),
         antigenf=factor(antigenf))


```

```{r roc cutoffs, echo=TRUE, message=FALSE, warning=FALSE}
#----------------------------
# Add ROC cutoffs 
# Estimated by Diana Martin
# for years 1 and 2-4 for antigens
# included in multiple years
#----------------------------
dl$roccut <- NA
dl$roccut[dl$antigen %in% "vsp3"] <- log10(116) 
dl$roccut[dl$antigen %in% "vsp5"] <- log10(109) 
dl$roccut[dl$antigen %in% "cp23"] <- log10(1185)
dl$roccut[dl$antigen %in% "cp17"] <- log10(321)
dl$roccut[dl$antigen %in% "leca"] <- log10(153)
dl$roccut[dl$antigen %in% "pgp3"] <- log10(818)


# different cutoffs for bead set used in years 2-4
dl$roccut[dl$antigen %in% "vsp3"  & dl$svy >1] <- log10(170)
dl$roccut[dl$antigen %in% "vsp5"  & dl$svy >1] <- log10(141)
dl$roccut[dl$antigen %in% "cp23"  & dl$svy >1] <- log10(378) 
dl$roccut[dl$antigen %in% "cp17"  & dl$svy >1] <- log10(180) 
dl$roccut[dl$antigen %in% "leca"  & dl$svy >1] <- log10(94)
dl$roccut[dl$antigen %in% "pgp3"  & dl$svy >1] <- log10(882)

```

## Age stratified antibody distributions

This is a beadset-stratified version of Figure 1 - supplement 1 in the article.

```{r age stratified distribution figure, fig.width=12,fig.height=6}
# create age categories
dlplot <- dl %>%
  mutate(agecat = cut(age,breaks=c(0,1,2,3,4,10),
                      labels=c("1 year","2 years","3 years","4 years","5-9 years")),
         antigenf=factor(antigenf,levels=mbalabs)
         ) %>%
  filter(antigen!="pgp3") %>% mutate(antigenf=droplevels(antigenf)) %>%
  group_by(antigen) %>%
  mutate(plotroc=min(roccut))


# custom color blind color palette is in the preamble chunck
pcols <- c(cteal,corange)



# custom log labels
log10labs <- c( 
  expression(10^0),
  expression(10^1),
  expression(10^2),
  expression(10^3),
  expression(10^4)
)

# faceted over age and antigen
p2 <- ggplot(data=dlplot,aes(x=logmfi,group=beadset,fill=beadset,color=beadset)) +
  facet_grid(agecat~antigenf,scales='free')+
  geom_density(aes(y=..density..),color=NA,alpha=0.5)+
  geom_vline(aes(xintercept = roccut,color=beadset)) +
  coord_cartesian(ylim=c(0, 1.25))+
  scale_x_continuous(expand=c(0,0),limits=c(0,5),breaks=0:4,labels=log10labs) +
  scale_fill_manual(values=pcols)+
  scale_color_manual(values=pcols)+
  labs(title="",x="Luminex Response (MFI-bg)",y="Density") +
  theme_minimal()+
  theme(
    strip.text.x = element_text(size=9),
    strip.text.y=element_text(size=12,angle=0),
    legend.position="top"
  )

p2
```

The patterns are very similar across beadsets. Vertical lines are ROC-cutoffs for each beadset.

Below is a figure that contrasts the distribution of the Year 1 beadset (blue) with the overall distribution (black line); and then Years 2-4 beadset (orange) with the overall distribution (black line).  The plots  show that the combined analysis, which pools data over all years, essentially reflects the patterns observed in years 2-4 -- consistent with that bead set contributing >4 times more observations to the analysis (n=4,087 vs n=902).

```{r distribution comparison to overall, fig.width=12,fig.height=6}
# faceted over age and antigen
p3 <- ggplot(data=dlplot,aes(x=logmfi)) +
  facet_grid(agecat~antigenf,scales='free')+
  geom_density(data=filter(dlplot,beadset=="Year 1"), aes(y=..density..),fill=cteal,color=NA,alpha=0.5)+
  geom_density(aes(y=..density..),fill=NA,color="black")+
  # scale_y_continuous(expand=c(0,0),breaks=seq(0,40,by=10)) +
  coord_cartesian(ylim=c(0, 1.25))+
  scale_x_continuous(expand=c(0,0),limits=c(0,5),breaks=0:4,labels=log10labs) +

  labs(title="",x="Luminex Response (MFI-bg)",y="Density") +
  theme_minimal()+
  theme(
    strip.text.x = element_text(size=9),
    strip.text.y=element_text(size=12,angle=0),
    legend.position="top"
  )

p3

p4 <- ggplot(data=dlplot,aes(x=logmfi)) +
  facet_grid(agecat~antigenf,scales='free')+
  geom_density(data=filter(dlplot,beadset=="Years 2-4"), aes(y=..density..),fill=corange,color=NA,alpha=0.5)+
  geom_density(aes(y=..density..),fill=NA,color="black")+
  coord_cartesian(ylim=c(0, 1.25))+
  scale_x_continuous(expand=c(0,0),limits=c(0,5),breaks=0:4,labels=log10labs) +

  labs(title="",x="Luminex Response (MFI-bg)",y="Density") +
  theme_minimal()+
  theme(
    strip.text.x = element_text(size=9),
    strip.text.y=element_text(size=12,angle=0),
    legend.position="top"
  )

p4

```

## Joint distribution of antibody response

Summarize the joint distribution of antibody response, stratified by beadsets used in Y1 and Y2-4 for antigens included in both beadsets.

```{r group antigens and reshape}
#--------------------------------
# create antigen groupings for
# comparisons
# drop obs not contributing
#--------------------------------
dl2 <- dl %>%
  mutate(comp= ifelse(antigen %in% c("vsp3","vsp5"),"Giardia",NA),
         comp= ifelse(antigen %in% c("cp17","cp23"),"Cryptosporidium",comp),
         comp= factor(comp,levels=c("Giardia","Cryptosporidium"))
         ) %>% 
  mutate(xlab=ifelse(antigen %in% c("vsp3","vsp5"),"VSP-3",NA),
         ylab=ifelse(antigen %in% c("vsp3","vsp5"),"VSP-5",NA),
         xlab=ifelse(antigen %in% c("cp17","cp23"),"Cp17",xlab),
         ylab=ifelse(antigen %in% c("cp17","cp23"),"Cp23",ylab)
         ) %>%
  filter(!is.na(comp))

#--------------------------------
# for antigen each pair, 
# label it as "x" or "y" to 
# spread it to wide format
#--------------------------------
dw <- dl2 %>%
  mutate(xy=ifelse(antigen %in% c("vsp3","cp17"),"x","y")) %>%
  select(beadset,comp,xlab,ylab,id,xy,logmfi) %>%
  spread(xy,logmfi) %>%
  mutate(beadset=factor(beadset,levels=c("Year 1","Years 2-4")))

```

```{r est correlations}
#--------------------------------
# estimate spearman's correlation
# within each country, comparison
#--------------------------------
dcorr <- dw %>%
  group_by(beadset,comp) %>%
  mutate(corxy=cor(x,y,method="spearman",use="pairwise.complete.obs") ) %>%
  summarize(corxy=max(corxy,na.rm=T))
```

```{r est trimmed smooths}
#--------------------------------
# estimate smooths, trimmed to
# drop the bottom and top 1% of
# data in each comparison
# to avoid edge effects
#--------------------------------
dsmooths <- foreach(beadseti=levels(dw$beadset),.combine=rbind) %:%
                      foreach(compi=levels(dw$comp),.combine=rbind) %do% {
                        pd <- filter(dw,beadset==beadseti & comp==compi)
                        if(nrow(pd)>0) {
                          xqs <- quantile(pd$x,probs=c(0.01,0.99),na.rm=TRUE)
                          newd <- data.frame(x=seq(xqs[1],xqs[2],by=0.01))
                          lfit <- loess(y~x,data=pd)
                          return(data.frame(beadset=beadseti,comp=compi,x=newd,y=predict(lfit,newdata=newd)))
                        }
                        
  
}

```

```{r composite figure,fig.width=7,fig.height=9 }

pcols <- c(cteal,corange)

# grab labels
dlabs <- dw %>% select(beadset,comp,xlab,ylab) %>% group_by(beadset,comp) %>% slice(1)

complot <- ggplot(data=dw,aes(x=x,y=y,color=beadset)) +
  facet_grid(comp~beadset) +
  geom_point(pch=19,alpha=0.1) +
  geom_line(data=dsmooths,aes(x=x,y=y),col="black",size=1.2)+
  geom_text(data=dcorr,
            aes(x=0.5,y=4.3,label=paste("rho ==",sprintf("%1.2f",corxy)) ),
            parse=TRUE, col="black")   +
  geom_text(data=dlabs,aes(x=2.3,y=0.1,label=xlab),color="gray40",angle=0)+
  geom_text(data=dlabs,aes(x=0.1,y=2.3,label=ylab),color="gray40",angle=90)+
  scale_x_continuous(limits=c(0,4.6),breaks=0:4,labels = log10labs)+
  scale_y_continuous(limits=c(0,4.6),breaks=0:4,labels = log10labs)+
  scale_color_manual(values=pcols) +
  coord_equal() +
  labs(x="Luminex Response (MFI-bg)",y="Luminex Response (MFI-bg)") +
  theme_minimal(base_size=12) +
  theme(
    strip.text.x=element_text(size=12),
    strip.text.y=element_text(size=12,angle=0),
    legend.position="none"
  )


complot

```


Stratified version of Figure 2 in the main text.
The relationships and correlation estimates are nearly identical across beadsets.


## Age-dependent mean curves
Estimate age-dependent mean log10 MFI-bg in the Tanzania study, separately for the two different bead sets.
```{r age-curve mean gam}

# ---------------------------------------
# fit cubic spline over age, separately for each antigen
# and beadset
# estimate approximate simultaneous confidence intervals
# for the fits
# ---------------------------------------
library(mgcv)
gamfits <- foreach(ab=levels(dl$antigenf),.combine=rbind) %:%
  foreach(beadseti=levels(dl$beadset),.combine=rbind) %dopar% {
    pd <- dplyr::filter(dl, antigenf==ab & beadset==beadseti)
    gfit <- gam(logmfi~s(age, bs="cr",k=9),data=pd)
    gsci <- gamCI(m=gfit,newdata=pd,nreps=1000)
    gsci$antigen <- ab
    return(gsci)
  }

# ---------------------------------------
# get overall, pooled estimate
# ---------------------------------------
gamfits2 <- foreach(ab=levels(dl$antigenf),.combine=rbind) %dopar% {
    pd <- dplyr::filter(dl, antigenf==ab)
    gfit <- gam(logmfi~s(age, bs="cr",k=9),data=pd)
    gsci <- gamCI(m=gfit,newdata=pd,nreps=1000)
    gsci$antigen <- ab
    gsci$beadset <- factor("Combined",levels=c("Year 1","Years 2-4","Combined"))
    return(gsci)
}

gamfits <- gamfits %>%
  mutate(beadset=factor(beadset,levels=c("Year 1","Years 2-4","Combined"))) %>%
  bind_rows(gamfits2)

```



```{r age-curve mean figure tanzania, fig.height=12, fig.width=6}

log10labs <- c( 
  expression(10^0),
  expression(10^1),
  expression(10^2),
  expression(10^3),
  expression(10^4)
)


dplot <- data.frame(gamfits) %>%
  dplyr::filter(pathogen!="V. cholerae") %>%
  mutate(pathogen=factor(pathogen,levels=c("Giardia",
                                           "Cryptosporidium",
                                           "E. histolytica",
                                           "ETEC")),
         antigenf=factor(antigenf,levels=c("Giardia VSP-3","Giardia VSP-5",
                                           "Cryptosporidium Cp17","Cryptosporidium Cp23",
                                           "E. histolytica LecA",
                                           "ETEC LT B subunit")))

pcols <- c(cteal,corange,cblack)

pcurve <- ggplot(data=dplot,aes(x=age+0.5,group=beadset,color=beadset,fill=beadset)) +
  # approximate simultaneous CI from spline fit
  geom_ribbon(aes(ymin=lwrS,ymax=uprS),alpha=0.2,color=NA) +
  # spline fit
  geom_line(aes(y=fit)) +
  # plot aesthetics
  facet_wrap(~antigenf,nrow=6,ncol=2) +
  scale_x_continuous(limits=c(0,10),breaks=seq(0,10,by=2))+
  scale_y_continuous(breaks=0:4,labels=log10labs)+
  coord_cartesian(ylim=c(0,4.5))+
  labs(x="Age in years",y="Luminex Response (MFI-bg)") +
  scale_fill_manual(values=pcols) +
  scale_color_manual(values=pcols) +
  theme_minimal(base_size=16) +
  theme(legend.position = "top")

pcurve


```

The results show that in general the MFI-bg levels were slightly lower in year 1 than in years 2-4, but that the qualitative age-dependent patterns are similar. Since year is perfectly confounded by bead lot, there is no way to distinguish whether differences are due to between-year differences in exposure or due to bead lot effects.  The plots also show that the combined analysis, which pools data over all years, essentially reflects the patterns observed in years 2-4 -- consistent with that bead set contributing >4 times more observations to the analysis (n=4,087 vs n=902).

# Leogane, Haiti seasonal effects

Of the three studies included in this analysis, Haiti was the only cohort that spanned wet and rainy seasons. Following seasonsal definitions for Haiti described by Moss et al. 2004, we examined the effect of season on IgG levels and seroprevalence. 

In Haiti, there are two rainy seasons: from April - June and August - October. We classified measurements collected in these months as wet season measurements, and all others as dry season measurements. We then compared distributions of IgG, mean IgG levels, and seroprevalence between the two seasons. We also compared age-dependent mean IgG levels stratified by season to examine whether the curves suggested evidence for a shift, as has been demonstrated for malaria in a very high transmission setting (Arnold et al. 2017).  We found some evidence for slightly higher IgG levels and seroprevalence, but differences were small and there was no evidence for dramatic shifts in the age-dependent mean curves.

Moss, D. M., Priest, J. W., Hamlin, K., Derado, G., Herbein, J., Petri, W. A., Jr & Lammie, P. J. Longitudinal evaluation of enteric protozoa in Haitian children by stool exam and multiplex serologic assay. Am. J. Trop. Med. Hyg. 90, 653–660 (2014).

Arnold, B. F., van der Laan, M. J., Hubbard, A. E., Steel, C., Kubofcik, J., Hamlin, K. L., Moss, D. M., Nutman, T. B., Priest, J. W. & Lammie, P. J. Measuring changes in transmission of neglected tropical diseases, malaria, and enteric pathogens from quantitative antibody levels. PLoS Negl. Trop. Dis. 11, e0005616 (2017).

## Load the data and format
```{r load haiti data}
#-----------------------------
# load the formatted data
# with seropositivity indicators
# created with:
# haiti-enteric-ab-data-format.Rmd -->
# Fig1-haiti-enteric-ab-distributions.Rmd
#-----------------------------
dl <- readRDS(here::here("data","haiti_analysis2.rds"))

# list the enteric antigens and make formatted labels for them
mbavars <- c("vsp3","vsp5","cp17","cp23","leca","salb","sald","p18","p39","etec","cholera")

mbalabs <- c("Giardia VSP-3","Giardia VSP-5","Cryptosporidium Cp17","Cryptosporidium Cp23","E. histolytica LecA","Salmonella LPS B","Salmonella LPS D","Campylobacter p18","Campylobacter p39","ETEC LT B subunit","Cholera toxin β subunit")

#-----------------------------
# Following the analysis in
# Moss et al. 2014, there are
# generally two annual rainy
# seasons in Haiti:
# April - June, August - October
# Moss, D. M., et al. Am. J. Trop. Med. Hyg. 90, 653–660 (2014).
#-----------------------------
dl <- dl %>%
  mutate(season=ifelse(month %in% c(4,5,6,8,9,10),"wet season","dry season"),
         season=factor(season,levels=c("dry season","wet season"))
)

```

## Age and MFI distributions by season
Examine distribution of measurement ages by season to confirm there is not significant imbalance
```{r haiti season measures}
#-----------------------------
# distribution of measurement
# ages by season
#-----------------------------
dplot_age <- dl %>% filter(pathogen=="ETEC")

page <- ggplot(data=dplot_age,aes(x=age,stat(density),color=season,fill=season)) +
  geom_density(alpha=0.4)+
  scale_fill_manual(values=cbPalette[c(2,6)])+
  scale_color_manual(values=cbPalette[c(2,6)])
page

page2 <- ggplot(data=dplot_age,aes(x=age,stat(density),color=season,fill=season)) +
  geom_histogram(alpha=0.4,bins=30)+
  scale_fill_manual(values=cbPalette[c(2,6)])+
  scale_color_manual(values=cbPalette[c(2,6)])
page2

```

Examine MFI by antibody and season

```{r haiti MFI boxplot by season, fig.width=10}
dlplot <- dl %>% 
  mutate(season=factor(ifelse(season=="dry season","dry","wet"),levels=c("dry","wet")))

log10labs <- c( 
  expression(10^0),
  expression(10^1),
  expression(10^2),
  expression(10^3),
  expression(10^4)
)

pcols <- cbPalette[c(2:4,6:8)]

pbox_season <- ggplot(data=dlplot,aes(x=season,y=logmfi,color=pathogen,fill=pathogen))+
  facet_grid(~antigenf)+
  geom_jitter(height=0,width=0.2,size=0.4,alpha=0.5) +
  geom_boxplot(outlier.shape=NA,color="gray30",fill=NA)+
  scale_y_continuous(breaks=0:4,labels=log10labs)+
  scale_color_manual(values=pcols)+
  scale_fill_manual(values=pcols)+
  coord_cartesian(ylim=c(0,4.5))+
  labs(y="Luminex response (MFI-bg)")+
  theme(
    legend.position="none",
    strip.text=element_text(size=6)
  )

pbox_season


```

The boxplots suggest a slight shift in IgG to higher levels for many pathogens, including Giardia, Cryptosporidium, Salmonella, and norovirus. Below, we examine differences in mean MFI and seroprevalence, adjusting for age and accounting for repeated measures among children.

## MFI by season, adjusted for age

```{r haiti season mean MFI}
#-----------------------------
# estimate means by season 
# and difference between
# seasons using targeted maximum
# likelihood estimation
# get 95% CIs through the
# influence curve clustered
# on child ID
# adjust for age with a GAM
#-----------------------------
mfi_tmlemeans <- foreach(seasi=levels(dl$season),.combine=rbind) %:% 
  foreach(ab=levels(dl$antigenf),.combine=rbind) %dopar% {
    pd <- filter(dl,season==seasi & antigenf==ab)
    mu <- tmleAb(Y=pd$logmfi,id=pd$id,W=pd$age,
                 SL.library=c("SL.gam")
                 )
    di <- data.frame(season=seasi,antigenf=ab,mean=mu$psi,se=mu$se,lb=mu$lb,ub=mu$ub)
    return(di)
  }

mfi_tmlediffs <- foreach(ab=levels(dl$antigenf),.combine=rbind) %dopar% {
    pd <- filter(dl,antigenf==ab) %>% mutate(wet=ifelse(season=="wet season",1,0))
    diffmu <- tmleAb(Y=pd$logmfi,X=pd$wet,W=pd$age,
                     id=pd$id,SL.library=c("SL.gam")
                     )
    di <- data.frame(antigenf=ab,diff=diffmu$psi,lb=diffmu$lb,ub=diffmu$ub,p=diffmu$p)
    return(di)
  }

# bring back pathogen info for ploting aesthetics
haiti_paths <- dl %>%
  ungroup() %>%
  group_by(antigenf) %>%
  select(antigenf,pathogen) %>%
  slice(1)

mfi_tmlemeans <- mfi_tmlemeans %>% left_join(haiti_paths,by="antigenf") %>%
  mutate(season=ifelse(season=="dry season","dry","wet"))
mfi_tmlediffs <- mfi_tmlediffs %>% left_join(haiti_paths,by="antigenf")

```


```{r haiti season MFI figure, fig.width=10}
pcols <- cbPalette[c(2:4,6:8)]

log10labs <- c( 
  expression(10^1),
  expression(10^2),
  expression(10^3),
  expression(10^4)
)

p_mfi_season <- ggplot(data=mfi_tmlemeans,aes(x=season,y=mean,color=pathogen,fill=pathogen))+
  facet_grid(.~antigenf)+
  geom_errorbar(aes(ymin=lb,ymax=ub),width=0.1)+
  geom_point()+
  labs(y="adjusted mean Luminex response (MFI-bg)")+
  scale_color_manual(values=pcols)+
  scale_fill_manual(values=pcols)+
  scale_y_continuous(breaks=1:4,labels=log10labs)+
  coord_cartesian(ylim=c(1,4.5))+
  theme(
    legend.position="none",
    strip.text=element_text(size=6)
  )

p_mfi_season
```

```{r haiti season MFI diff figure,fig.width=8}
pcols <- cbPalette[c(2:4,6:8)]

p_mfi_diff_season <- ggplot(data=mfi_tmlediffs,aes(x=antigenf,y=diff,color=pathogen,fill=pathogen))+
  geom_errorbar(aes(ymin=lb,ymax=ub),width=0.1)+
  geom_point()+
  geom_hline(yintercept=0,linetype="dashed")+
  labs(y="increase in response during wet season (log10 MFI-bg)",x="Antibody")+
  scale_color_manual(values=pcols)+
  scale_fill_manual(values=pcols)+
  # scale_y_continuous(breaks=1:4,labels=log10labs)+
  # coord_cartesian(ylim=c(1,4.5))+
  theme(
    legend.position="none",
    axis.text.x=element_text(angle=45,hjust=1)
  )

p_mfi_diff_season
```

This analysis shows that mean MFI is higher across antibodies during the wet season compared to the dry season, even after adjusting for age. However, the magnitude of the differences is small and on the order of 0.1 to 0.2 (log10). Below, we compared seroprevalence by season.


## Seroprevalence by season
```{r haiti season seroprev adjusted}

#----------------------------------
# create seropositivity indicators 
# combining information over antigens
#----------------------------------
dlp <- dl %>%
  mutate(pathogen2 = case_when(
    antigenf == "Norovirus GI.4" ~ "Norovirus GI.4",
    antigenf == "Norovirus GII.4.NO" ~ "Norovirus GII.4.NO",
    TRUE ~ as.character(pathogen)),
    pathogen2=factor(pathogen2,levels=c("Giardia","Cryptosporidium","E. histolytica","Salmonella","ETEC","Norovirus GI.4","Norovirus GII.4.NO"))
  ) %>%
  mutate(seropos=ifelse(!is.na(posroc),posroc,posmix),
         serocut=ifelse(!is.na(posroc),log10(roccut),mixcut),
         serocut_desc=ifelse(!is.na(posroc),"ROC","Mixture Model")) %>%
  mutate(seropos=ifelse(!is.na(seropos),seropos,posunex),
         serocut_desc=ifelse(!is.na(serocut),serocut_desc,"Unexp dist"),
         serocut=ifelse(!is.na(serocut),serocut,unexpcut)) %>%
  ungroup() %>% 
  group_by(pathogen,pathogen2,id,sampleid,agecat,age,season) %>%
  summarize(seropos=max(seropos))

dlp <- dlp %>%
  ungroup() %>%
  mutate(id=as.character(id))

#-----------------------------
# estimate seroprevalence by season 
# and difference between
# seasons using targeted maximum
# likelihood estimation
# also estimate the risk ratio
# get 95% CIs through the
# influence curve clustered
# on child ID
# adjust for age with a GAM
#-----------------------------
serop_tmlemeans <- foreach(seasi=levels(dlp$season),.combine=rbind) %:% 
  foreach(ab=levels(dlp$pathogen2),.combine=rbind) %dopar% {
    pd <- filter(dlp,season==seasi & pathogen2==ab)
    mu <- tmleAb(Y=pd$seropos,id=pd$id,W=pd$age,
                 SL.library=c("SL.gam"),
                 family="binomial")
    di <- data.frame(season=seasi,pathogen2=ab,mean=mu$psi,se=mu$se,lb=mu$lb,ub=mu$ub)
    return(di)
  }

serop_tmlediffs <- foreach(ab=levels(dlp$pathogen2),.combine=rbind) %dopar% {
    pd <- filter(dlp,pathogen2==ab) %>% mutate(wet=ifelse(season=="wet season",1,0))
    diffmu <- tmleAb(Y=pd$seropos,X=pd$wet,W=pd$age,
                     id=pd$id,SL.library=c("SL.gam"),
                     family="binomial")
    di <- data.frame(pathogen2=ab,diff=diffmu$psi,lb=diffmu$lb,ub=diffmu$ub,p=diffmu$p,
                     rr=diffmu$tmle_fit$estimates$RR$psi,
                     rr_lb=diffmu$tmle_fit$estimates$RR$CI[1],
                     rr_ub=diffmu$tmle_fit$estimates$RR$CI[2])
    return(di)
  }

# bring back pathogen info for ploting aesthetics
haiti_paths2 <- dlp %>%
  ungroup() %>%
  group_by(pathogen2) %>%
  select(pathogen2,pathogen) %>%
  slice(1)

serop_tmlemeans <- serop_tmlemeans %>% left_join(haiti_paths2,by="pathogen2") %>%
  mutate(season=ifelse(season=="dry season","dry","wet"))
serop_tmlediffs <- serop_tmlediffs %>% left_join(haiti_paths2,by="pathogen2")

```

```{r haiti season seroprev figure,fig.width=10}
pcols <- cbPalette[c(2:4,6:8)]

p_serop_season <- ggplot(data=serop_tmlemeans,aes(x=season,y=mean,color=pathogen,fill=pathogen))+
  facet_grid(.~pathogen2)+
  geom_errorbar(aes(ymin=lb,ymax=ub),width=0.1)+
  geom_point()+
  labs(y="seroprevalence (%)")+
  scale_color_manual(values=pcols)+
  scale_fill_manual(values=pcols)+
  scale_y_continuous(breaks=seq(0,1,by=0.1),labels=sprintf("%1.0f",seq(0,1,by=0.1)*100))+
  coord_cartesian(ylim=c(0,1))+
  theme(
    legend.position="none"
  )

p_serop_season
```


```{r haiti season seroprev diff figure}
# custom color blind color palette is in the preamble chunck
pcols <- cbPalette[c(2:4,6:8)]
serop_tmlediffs <- serop_tmlediffs %>%
  mutate(difflab = sprintf("%1.1f",diff*100))
p_serop_diff_season <- ggplot(data=serop_tmlediffs,aes(x=pathogen2,y=diff,color=pathogen,fill=pathogen))+
  geom_errorbar(aes(ymin=lb,ymax=ub),width=0.1)+
  geom_point()+
  geom_text(aes(y=diff,label=difflab),nudge_x = 0.2)+
  geom_hline(yintercept=0,linetype="dashed")+
  labs(y="increase in seroprevalence during wet season (%)",x="Pathogen")+
  scale_color_manual(values=pcols)+
  scale_fill_manual(values=pcols)+
  scale_y_continuous(breaks=seq(-0.04,0.12,by=0.02),labels=sprintf("%1.0f",seq(-0.04,0.12,by=0.02)*100))+
  coord_cartesian(ylim=c(-0.04,0.12))+
  theme(
    legend.position="none",
    axis.text.x=element_text(angle=45,hjust=1)
  )

p_serop_diff_season

```


```{r haiti season seroprev rr figure}
# custom color blind color palette is in the preamble chunck
pcols <- cbPalette[c(2:4,6:8)]
serop_tmlediffs <- serop_tmlediffs %>%
  mutate(rrlab = sprintf("%1.2f",rr))
p_serop_rr_season <- ggplot(data=serop_tmlediffs,aes(x=pathogen2,y=rr,color=pathogen,fill=pathogen))+
  geom_errorbar(aes(ymin=rr_lb,ymax=rr_ub),width=0.1)+
  geom_point()+
  geom_text(aes(y=rr,label=rrlab),nudge_x = 0.2)+
  geom_hline(yintercept=1,linetype="dashed")+
  labs(y="wet season prevalence ratio",x="Pathogen")+
  scale_color_manual(values=pcols)+
  scale_fill_manual(values=pcols)+
  scale_y_log10(breaks=c(0.9,1,1.1,1.2))+
  coord_cartesian(ylim=c(0.9,1.2))+
  theme(
    legend.position="none",
    axis.text.x=element_text(angle=45,hjust=1)
  )

p_serop_rr_season

```

Consistent with comparisons of IgG levels, this analysis demonstrated that seroprevalence was consistently elevated during the wet season across pathogens, but the increase was small, ranging from 0.8 to 4.8 percentage points, or relative increase of between 1 and 7 percent.

## Estimate age-seroprevalence curves by season
Above, there was slight evidence for higher IgG levels and seroprevalence across pathogens during the wet season as compared to the dry season. Below, estimate age-dependent mean MFI levels using cubic splines to examine whether season changes these overall patterns by age. The results suggest differences between seasons are very slight, consistent with the results above.

```{r gam functions for simultaneous cis}
#----------------------------------
# simulataneous CIs for GAMs
# estimated by resampling the 
# Baysian posterior estimates of
# the variance-covariance matrix
# assuming that it is multivariate normal
# the function below also estimates 
# the unconditional variance-covariance
# matrix, Vb=vcov(x,unconditional=TRUE), 
# which allows for undertainty in the actual
# estimated mean as well 
# (Marra & Wood 2012 Scandinavian Journal of Statistics, 
#  Vol. 39: 53–74, 2012, doi: 10.1111/j.1467-9469.2011.00760.x )
# simultaneous CIs provide much better coverage than pointwise CIs
# see: http://www.fromthebottomoftheheap.net/2016/12/15/simultaneous-interval-revisited/
#----------------------------------

gamCI <- function(m,newdata,nreps=10000) {
  require(mgcv)
  require(dplyr)
  Vb <- vcov(m,unconditional = TRUE)
  pred <- predict(m, newdata, se.fit = TRUE)
  fit <- pred$fit
  se.fit <- pred$se.fit
  BUdiff <- MASS::mvrnorm(n=nreps, mu = rep(0, nrow(Vb)), Sigma = Vb)
  Cg <- predict(m, newdata, type = "lpmatrix")
  simDev <- Cg %*% t(BUdiff)
  absDev <- abs(sweep(simDev, 1, se.fit, FUN = "/"))
  masd <- apply(absDev, 2L, max)
  crit <- quantile(masd, prob = 0.95, type = 8)
  pred <- data.frame(newdata,fit=pred$fit,se.fit=pred$se.fit)
  pred <- mutate(pred,
                 uprP = fit + (2 * se.fit),
                 lwrP = fit - (2 * se.fit),
                 uprS = fit + (crit * se.fit),
                 lwrS = fit - (crit * se.fit)
  )
  return(pred)
}
```

Estimate age dependent mean MFI curves by season
```{r haiti age MFI curves by season }
#-----------------------------
# fit cubic spline over age, separately for each 
# season and antigen
# estimate approximate simultaneous confidence intervals
# for the fits
# set the dummy to 0 to 
# zero out child-level random effects
# see posts on Stack Exchange for explanation:
# https://stats.stackexchange.com/questions/131106/predicting-with-random-effects-in-mgcv-gam/131116#131116
# https://stats.stackexchange.com/questions/189384/predicting-mean-smooth-in-gam-with-smooth-by-random-factor-interaction
#-----------------------------

#-----------------------------
# create a dummy variable equal
# to 1 for all obs as a trick to
# get marginal predictions by
# age while still including REs
# for child
#-----------------------------
dl <- dl %>%
  ungroup() %>%
  mutate(dummy=1) %>%
  mutate(id=as.character(id),
         fid=factor(id))

library(mgcv)
gamfits <- foreach(ab=levels(dl$antigenf),.combine=rbind) %dopar% {
    pd <- filter(dl, antigenf==ab)
    gfit <- mgcv::gam(logmfi~s(age, bs="cr",by=season)+s(fid,bs="re",by=dummy)+season, data=pd)
    newd0 <- pd %>% mutate(dummy=0,season="dry season")
    newd1 <- pd %>% mutate(dummy=0,season="wet season")
    gsci0 <- gamCI(m=gfit,newdata=newd0,nreps=1000)
    gsci1 <- gamCI(m=gfit,newdata=newd1,nreps=1000)
    gsci <- bind_rows(gsci0,gsci1) %>% mutate(antigenf=ab)
    return(gsci)
}

# reinstate factors
gamfits <- gamfits %>%
  mutate(antigenf=factor(antigenf,levels=levels(dl$antigenf)),
         season=factor(season,levels=c("dry season","wet season"))
  )
  
```

Figure of age-dependent mean MFI curves

```{r haiti age-MFI by season figure, fig.width=6 , fig.height=12}
# bright color-blind palette defined in an earlier code chunk
pcols <- cbPalette[c(2,6)]

log10labs <- c( 
  expression(10^0),
  expression(10^1),
  expression(10^2),
  expression(10^3),
  expression(10^4)
)

pcurve <- ggplot(data=gamfits,aes(x=age,color=season,fill=season)) +
  # approximate simultaneous CI from spline fit
  geom_ribbon(aes(ymin=lwrS,ymax=uprS),alpha=0.2,color=NA) +
  # spline fit
  geom_line(aes(y=fit)) +
  # plot aesthetics
  facet_wrap(~antigenf,nrow=5,ncol=2) +
  scale_x_continuous(breaks=seq(0,10,by=1))+
  scale_y_continuous(breaks=0:4,labels=log10labs)+
  coord_cartesian(ylim=c(0,4.5),xlim=c(0,10))+
  labs(x="age in years",y="Luminex response (MFI-bg)") +
  scale_fill_manual(values=pcols) +
  scale_color_manual(values=pcols) +
  theme_minimal() +
  theme(legend.position = "top")

pcurve

```



# Session Info
```{r session info}
sessionInfo()
```

