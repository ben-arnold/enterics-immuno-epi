---
title: "Asembo enteric antibody analysis of longitudinal change"
output:
  html_notebook:
    highlight: haddock
    theme: default
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: yes
      smooth_scroll: yes
  html_document:
    highlight: haddock
    theme: default
    code_folding: show
    df_print: paged
    toc: yes
    toc_depth: '3'
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---

# Summary

This script summarizes the change in antibody levels within individual children and also estimates the incidence proportion over a 6-7 month period of seroconversion and seroreversion.

The Asembo study was longitudinal and followed children prospectively. We can estimate the average seroconversion rate among children who were at risk (seronegative) at enrollment and seroconverted during the study. We can also estimate the sero-reversion rate, albeit with very little precision since, with the exception of rotavirus, very few children were at risk (seropositive) at enrollment.

# Script preamble
```{r preamble}
#-----------------------------
# preamble
#-----------------------------
library(here)
here()

# load packages
library(tidyverse)
library(kableExtra)
library(ROCR)

# set up for parallel computing
# configure for a laptop (use only 3 cores)
library(foreach)
library(doParallel)
registerDoParallel(cores=3)

# bright color blind palette:  https://personal.sron.nl/~pault/ 
cblack <- "#000004FF"
cblue <- "#3366AA"
cteal <- "#11AA99"
cgreen <- "#66AA55"
cchartr <- "#CCCC55"
cmagent <- "#992288"
cred <- "#EE3333"
corange <- "#EEA722"
cyellow <- "#FFEE33"
cgrey <- "#777777"

```


```{r load data}
#-----------------------------
# load the formatted data
# created with 
# asembo-enteric-ab-data-format.Rmd
#-----------------------------
dl <- readRDS(here("data","asembo_analysis2.rds"))

# list the enteric antigens and make formatted labels for them
mbavars <- c("vsp3","vsp5","cp17","cp23","leca","rotavirus","salb","sald","p18","p39","etec","cholera")

mbalabs <- c("Giardia VSP-3","Giardia VSP-5","Cryptosporidium Cp17","Cryptosporidium Cp23","E. histolytica LecA","Rotavirus","Salmonella LPS B","Salmonella LPS D","Campylobacter p18","Campylobacter p39","ETEC toxin beta subunit","Cholera toxin beta subunit")
```

# Identify incident changes
Identify children whose status changed  between enrollment and follow-up. Those who changed from negative to positive are seroconverters (`seroi` below), and those who changed from positive to negative are seroreverters (`seror` below).


```{r long incidence}
#-----------------------------
# identify incident 
# seroconversions and reversions
# based on crossing the
# seropositivity cutoff
#-----------------------------
# spread the data to wide format to 
# identify incident sero-conversions and sero-reversions
# subset to the individuals measured at both timepoints
dlpw <- dl %>%
  select(childid,antigen,time,serocut,seropos) %>%
  spread(time,seropos) %>% 
  filter(!is.na(A) & !is.na(B)) %>%
  mutate(seroi=ifelse(B==1 & A==0,1,0),
         seror=ifelse(B==0 & A==1,1,0)) %>%
  select(childid,antigen,seroi,seror)

#  merge these new variables back to the main data
dlp <- left_join(dl,dlpw,by=c("childid","antigen"))

#-----------------------------
# identify incident 
# seroconversions and reversions
# based on a 4-fold change in MFI
# to above the cutoff (seroconversion)
# or starting above cutoff (seroreversion)
#-----------------------------
dlp <- dlp %>%
  group_by(antigen,antigenf,childid) %>%
  mutate(mfiA=ifelse(time=="A",logmfi,NA),
         mfiA=max(mfiA,na.rm=TRUE),
         mfiB=ifelse(time=="B",logmfi,NA),
         mfiB=max(mfiB,na.rm=TRUE),
         seroi4fold=ifelse(logmfidiff>log10(4) & mfiB>serocut,1,0),
         seror4fold=ifelse(logmfidiff< - log10(4) & mfiA>serocut,1,0)
  ) 



```

# Antibody MFI trajectories
Longitudinal antibody trajectories of individual children for all antigens measured, colored by the change in antibody levels (increases and decreases)
```{r change in antibody level figure, fig.height=12, fig.width=6}
#-----------------------------
# Plot individual antibody
# trajectories, colored
# by increases and decreases
#-----------------------------

# create an change category factor for plot aesthetics
dlp <- dlp %>%
  mutate(mficat=factor(ifelse(logmfidiff>0,"Increase","Decrease"),levels=c("Increase","Decrease")))

# convert time to numeric (for plotting)
dlp <- dlp %>%
  mutate(svy=ifelse(time=="A",0,1))

log10labs <- c( 
  expression(10^0),
  expression(10^1),
  expression(10^2),
  expression(10^3),
  expression(10^4)
)

ppq <- ggplot(data=filter(dlp,!is.na(mficat)),aes(x=svy,y=logmfi,group=factor(childid),color=mficat)) +
  # geom_point(alpha=0.2) +
  geom_line(alpha=0.2) +
  # geom_hline(aes(yintercept=mixcut),linetype="dashed") +
  
  scale_x_continuous(limits=c(-0.25,1.25),breaks=c(0,1),labels=c("Enrollment","Follow-up"))+
  scale_y_continuous(breaks=0:4,labels=log10labs) +
  scale_color_manual(values=c(corange,cteal,"gray80"),
                     guide=guide_legend(title="MFI change:",override.aes = list(alpha=1))
                     ) +
  facet_wrap(~antigenf,nrow=6,ncol=2) +
  labs(x="Measurement",y="Luminex response (MFI-bg)") +
  theme_minimal() +
  theme(
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.grid.major.y = element_blank(),
    axis.ticks.y=element_line(color="gray40"),
    legend.position = "top"
    )

ppq

# save a PDF version
ggsave(here("figs","asembo-ab-long-mfi.pdf"),plot=ppq,device="pdf",width=6,height=12)

```

Create the same figure of individual antibody trajectories between measurements, but limit it to antigens with seroincidence measures, and color the trajectories by seroconversion/reversion status. 

```{r change in antibody seroincidence figure, fig.height=9, fig.width=6}
#-----------------------------
# pull the incidence info
# and just merge it back
# to the full longidudinal data
#-----------------------------
dl2 <- dlp

# create an incidence category factor for plot aesthetics
# for seroconversion based on seropositivity only
dl2$icat <- factor(NA,levels=c("Seroconversion","Seroreversion","No change"))
dl2$icat[dl2$seroi==1] <- "Seroconversion"
dl2$icat[dl2$seror==1] <- "Seroreversion"
dl2$icat[dl2$seroi==0 & dl2$seror==0] <- "No change"


# create an incidence category factor for plot aesthetics
# for seroconversion based on 4-fold changes in MFI
dl2$i4cat <- factor(NA,levels=c("Seroconversion","Seroreversion","No change"))
dl2$i4cat[dl2$seroi4fold==1] <- "Seroconversion"
dl2$i4cat[dl2$seror4fold==1] <- "Seroreversion"
dl2$i4cat[dl2$seroi4fold==0 & dl2$seror==0] <- "No change"

# create an incidence category factor for plot aesthetics
# for seroconversion comparing both methods
dl2$icat_comp <- factor(NA,levels=c(">4-fold increase, across cutoff",">4-fold decrease",">4-fold increase, above cutoff","<4-fold change"))
dl2$icat_comp[dl2$seroi4fold==1 & dl2$seroi==1] <- ">4-fold increase, across cutoff"
dl2$icat_comp[dl2$seror4fold==1] <- ">4-fold decrease"
dl2$icat_comp[dl2$seroi4fold==1 & dl2$seroi==0] <- ">4-fold increase, above cutoff"
dl2$icat_comp[is.na(dl2$icat_comp)] <- "<4-fold change"


pp <- ggplot(data=filter(dl2,!is.na(icat)),aes(x=svy,y=logmfi,group=factor(childid),color=icat_comp)) +
  # geom_point(alpha=0.2) +
  geom_hline(aes(yintercept=serocut),linetype="dashed",size=0.3) +
  geom_line(alpha=0.2) +
  
  scale_x_continuous(limits=c(-0.25,1.25),breaks=c(0,1),labels=c("Enrollment","Follow-up"))+
  scale_y_continuous(breaks=0:4,labels=log10labs) +
  scale_color_manual(values=c(corange,cteal,cmagent,"gray80"),
                     guide=guide_legend(title="MFI change:", override.aes = list(alpha=1), ncol=2,nrow=2),
                     ) +
  facet_wrap(~antigenf,nrow=6,ncol=2) +
  labs(x="Measurement",y="Luminex response (MFI-bg)") +
  theme_minimal() +
  theme(
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.grid.major.y = element_blank(),
    axis.ticks.y=element_line(color="gray40"),
    legend.position = "top" 
    )

pp

# save a PDF version
ggsave(here("figs","asembo-ab-long-seroincidence.pdf"),plot=pp,device="pdf",width=6,height=12)

```



# Session Info
```{r session info}
sessionInfo()
```




