---
title: "Kongwa enteric antibody distributions and seropositivity cutoffs"
output: 
  html_notebook:
    theme: default
    highlight: haddock
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: true
---

# Summary

This script summarizes the distribution of enteric antibody responses in the Kongwa trachoma study. 

It fits Gaussian mixture models to the distributions, and where possible, estimates seropositivity cutoffs based on the mixture model fits.

For Giardia and Cryptosporidium antigens, the CDC lab estimated cutoff values using a receiver operator characteristic (ROC) curve approach with known positive and negative specimens. For these antigens, the script compares the classification of measurements by cutoff values derived from ROC and mixture models.

# Script preamble
```{r preamble}
#-----------------------------
# preamble
#-----------------------------
rm(list=ls())
library(tidyverse)
library(mixtools)

# set up for parallel computing
# configure for a laptop (use only 3 cores)
library(foreach)
library(doParallel)
registerDoParallel(cores=3)

# bright color blind palette:  https://personal.sron.nl/~pault/ 
cblack <- "#000004FF"
cblue <- "#3366AA"
cteal <- "#11AA99"
cgreen <- "#66AA55"
cchartr <- "#CCCC55"
cmagent <- "#992288"
cred <- "#EE3333"
corange <- "#EEA722"
cyellow <- "#FFEE33"
cgrey <- "#777777"

```


#Load the formatted data

```{r data format}
#-----------------------------
# load the formatted data
# created with 
# asembo-enteric-ab-data-format.Rmd
#-----------------------------
#--------------------------------
# load the kongwa dataset
#--------------------------------
dl <- readRDS("~/enterics-immuno-epi/data/kongwa_analysis.rds")

# list the enteric antigens and formatted labels for them
mbavars <- c("vsp3","vsp5","cp17","cp23","leca","etec","cholera","salb","sald","p18","p39")

mbalabs <- c("Giardia VSP-3","Giardia VSP-5","Cryptosporidium Cp17","Cryptosporidium Cp23",
             "E. histolytica LecA","ETEC toxin beta subunit","Cholera toxin beta subunit","Salmonella LPS B","Salmonella LPS D","Campylobacter p18","Campylobacter p39")
```

#Distribution of antibody levels

## All ages 1-9 years
```{r Ab distribution figure, fig.height=12, fig.width=6}

# custom color blind color palette is in the preamble chunck
pcols <- c(cred,corange,cgreen,cteal,cteal,cblue,cgrey)

# custom log labels
log10labs <- c( 
  expression(10^0),
  expression(10^1),
  expression(10^2),
  expression(10^3),
  expression(10^4)
)

p <- ggplot(data=dl,aes(x=logmfi,group=pathogen,color=pathogen,fill=pathogen)) +
  facet_wrap(~antigenf,nrow=6,ncol=2,scales="free_y") +
  geom_histogram(aes(y=..density..),bins=50,alpha=0.7) +
  geom_density(aes(fill=NULL),color=cgrey) +
  scale_x_continuous(limits = c(0,4.5),breaks = 0:4,labels=log10labs) +
  scale_fill_manual(values=pcols) +
  scale_color_manual(values=pcols) +
  labs(x="Luminex Response (MFI-bg)") +
  theme_minimal(base_size=16) +
  theme(legend.position = "none")

p

# save a PDF version
ggsave("~/enterics-immuno-epi/figs/kongwa-ab-distributions.pdf",plot=p,device="pdf",width=7,height=14)

```

## Stratified by Age

Since Campylobacter and Salmonella antigens were only measured in year 1, there are not enough observations to make stratified distributions.

```{r ab distribution figures by age}

for(i in 1:9) {
  p <- ggplot(data=filter(dl,age==i,!antigen %in% c("p18","p39","salb","sald")),
              aes(x=logmfi,group=pathogen,color=pathogen,fill=pathogen)) +
  facet_wrap(~antigenf,nrow=6,ncol=2,scales="free_y") +
  geom_histogram(aes(y=..density..),bins=50,alpha=0.7) +
  geom_density(aes(fill=NULL),color=cgrey) +
  scale_x_continuous(limits = c(0,4.5),breaks = 0:4,labels=log10labs) +
  coord_cartesian(ylim=c(0,2)) +
  scale_fill_manual(values=pcols) +
  scale_color_manual(values=pcols) +
  labs(x="Luminex Response (MFI-bg)",title=paste("Age",i,"years")) +
  theme_minimal(base_size=16) +
  theme(legend.position = "none")
  
  p

# save a PDF version
ggsave(file=paste("~/enterics-immuno-epi/figs/kongwa-ab-distributions-age-",i,".pdf",sep=""),plot=p,device="pdf",width=7,height=14)
}


```


#Seropositivity cutoff values 

Fit mixture models among children age 1 

```{r roc cutoffs, echo=TRUE, message=FALSE, warning=FALSE}
#----------------------------
# Add ROC cutoffs 
# Estimated by Diana Martin
# for years 1 and 2-4 for antigens
# included in multiple years
# included in the file:
# "Key for Ben Arnold.xlsx"
#----------------------------
dl$roccut <- NA
dl$roccut[dl$antigen %in% "vsp3"] <- 116 
dl$roccut[dl$antigen %in% "vsp5"] <- 109 
dl$roccut[dl$antigen %in% "cp23"] <- 1185
dl$roccut[dl$antigen %in% "cp17"] <- 321
dl$roccut[dl$antigen %in% "leca"] <- 153

# different cutoffs for bead set used in years 2-4
dl$roccut[dl$antigen %in% "vsp3"  & dl$svy >1] <- 170
dl$roccut[dl$antigen %in% "vsp5"  & dl$svy >1] <- 141
dl$roccut[dl$antigen %in% "cp23"  & dl$svy >1] <- 378 
dl$roccut[dl$antigen %in% "cp17"  & dl$svy >1] <- 180 
dl$roccut[dl$antigen %in% "leca"  & dl$svy >1] <- 94

```

```{r mixture cutoffs, echo=TRUE, message=FALSE, warning=FALSE}
#-----------------------------
# mixture models
#-----------------------------
fitmix <- function(x,lambda,k) {
  mixfit <- normalmixEM(x,lambda=lambda,k=k)
  mixcut <- mixfit$mu[order(mixfit$mu)][1]+3*mixfit$sigma[order(mixfit$mu)][1]
  cat(summary(mixfit),"\nCutoff value:",mixcut,"(log10 MFI), or:", round(10^mixcut),"(MFI)\n\n")
  # pull out fitted densities
  denmat <- matrix(NA,nrow=length(x),ncol=k)
  for(i in 1:k) {
    denmat[,i] <- mixfit$lambda[i] * dnorm(x,mean=mixfit$mu[i],sd=mixfit$sigma[i])
  }
  denmat <- data.frame(denmat)
  colnames(denmat) <- paste("den",1:k,sep="")
  # return original values plus fitted densities in a dataframe 
  # also return the cutoff value and normalmixEM object
  xden <- data.frame(x=x,denmat)
  list(xden=xden,mixcut=mixcut,mixfit=mixfit)
  
}


## mixture model fits
# store densities of mixture distributions
# and estimated cutoffs
# mixdens <- foreach(ab=c("vsp3","vsp5","cp17","cp23","etec","cholera","leca"),.combine=rbind) %do% {

mixdens <- foreach(ab=unique(dl$antigen),.combine=rbind) %do% {
  cat("\n\n Mixture model fit for ",ab,"\n\n")
  mixf <- fitmix(x=dl$logmfi[dl$antigen==ab & dl$age==1 & !is.na(dl$logmfi)],lambda=0.5,k=2)
  di <- mixf$xden
  di$mixcut <- mixf$mixcut
  di$antigen=ab
  di <- di %>% arrange(x) %>% select(antigen,mixcut,everything())
  di
}

# for vsp5, there is appears to be a negative distribution
# so try to estimate it with a 3-component mixture
# (commented out: inconsistent methodology)
# vsp5mix <- fitmix(x=dl$logmfi[dl$antigen=="vsp5" & dl$age==1 & !is.na(dl$logmfi)],lambda=0.5,k=3)
# vsp5dens <- vsp5mix$xden %>%
#   mutate(antigen="vsp5",
#          mixcut=vsp5mix$mixcut)
# mixdens <- mixdens %>%
#   filter(antigen!="vsp5")
# mixdens <- bind_rows(mixdens,vsp5dens)


# The only realistic cutoff values using a 2-component mixture are 
# for Giardia VSP-3 and for E. hist LecA
# set all the others to missing
mixcuts <- mixdens %>%
  group_by(antigen) %>% filter(row_number()==1) %>% select(antigen,mixcut) %>% ungroup()
mixcuts$mixcut[ !mixcuts$antigen %in% c("vsp3","leca")] <- NA

#-----------------------------
# merge in the mixture cutoffs
# to the main dataset
#-----------------------------
dl <- left_join(dl,mixcuts,by=c("antigen"))

```

## Figure of antibody mixture distributions

```{r Ab mixture distribution figure, fig.height=12, fig.width=6}

# Get the mixture density distributions
# Distributions for p18, ETEC and Cholera did not have reasonable
# fits to set them to missing
# set the pathogen field to an arbitrary value (Giardia) to 
# mesh with the global ggplot aesthetics
plotmixdens <- mixdens %>%
  mutate(den1p = ifelse(!antigen %in% c("vsp3","leca"),NA,den1),
         den2p = ifelse(!antigen %in% c("vsp3","leca"),NA,den2)) %>%
  mutate(antigenf=factor(antigen,levels=mbavars,labels=mbalabs),
         pathogen="Giardia"
         )

# custom color blind color palette (pcols)
# and custom log10 labels (log10labs)
# defined in a previous code chunk
# pmix <- ggplot(data=filter(dl,age==1 & !antigen %in% c("p18","p39","salb","sald")),
pmix <- ggplot(data=filter(dl,age==1),
               aes(x=logmfi,group=pathogen,color=pathogen,fill=pathogen)) +
  facet_wrap(~antigenf,nrow=6,ncol=2,scales="free_y") +
  # plot empirical distribution and smooth
  geom_histogram(aes(y=..density..),bins=50,alpha=0.7) +
  geom_density(aes(fill=NULL),color=cgrey) +
  # plot fitted mixture distributions
  geom_line(data=plotmixdens,aes(x=x,y=den1p),color=cblack) +
  geom_line(data=plotmixdens,aes(x=x,y=den2p),color=cblack) +
  # add vertical lines for the cutoff values
  geom_vline(aes(xintercept=log10(roccut))) +
  geom_vline(aes(xintercept=mixcut),linetype=2) +
  # labels and formatting
  scale_x_continuous(limits = c(0,4.5),breaks = 0:4,labels=log10labs) +
  coord_cartesian(ylim=c(0,2)) +
  labs(x="Luminex Response (MFI-bg)") +
  scale_fill_manual(values=pcols) +
  scale_color_manual(values=pcols) +
  theme_minimal(base_size = 16) +
  theme(legend.position = "none")

pmix

# save a PDF version
ggsave("~/enterics-immuno-epi/figs/kongwa-ab-mixture-distributions.pdf",plot=pmix,device="pdf",width=7,height=14)

```

## Figure of age-stratified antibody distributions, with cutoffs

```{r age stratified distribution figure, fig.width=12,fig.height=6}
# create age categories, display a single ROC cutoff, put
# E. hist back in its correct place
dlplot <- dl %>%
  mutate(agecat = cut(age,breaks=c(0,1,2,3,4,10),
                      labels=c("1 year","2 years","3 years","4 years","5-9 years")),
         antigenf=factor(antigenf,levels=mbalabs)
         ) %>%
  group_by(antigen) %>%
  mutate(plotroc=min(roccut))


# custom color blind color palette is in the preamble chunck
pcols <- c(cred,corange,cgreen,cteal,cteal,cblue,cgrey)

# custom log labels
log10labs <- c( 
  expression(10^0),
  expression(10^1),
  expression(10^2),
  expression(10^3),
  expression(10^4)
)

# faceted over age and antigen
p2 <- ggplot(data=dlplot,aes(x=logmfi,fill=pathogen,color=pathogen)) +
  facet_grid(agecat~antigenf,scales='free')+
  geom_density(aes(y=..density..),color=NA,alpha=0.7)+
  geom_vline(aes(xintercept = log10(plotroc))) +
  geom_vline(aes(xintercept = mixcut),linetype=2) +
  # scale_y_continuous(expand=c(0,0),breaks=seq(0,40,by=10)) +
  coord_cartesian(ylim=c(0, 1.25))+
  scale_x_continuous(expand=c(0,0),limits=c(0,5),breaks=0:4,labels=log10labs) +
  # scale_y_continuous(expand=c(0,0),breaks=c(0,0.5,1,1.5),labels=c("0","","1","")) +
  scale_fill_manual(values=pcols,guide_legend(title="Age category"))+
  labs(title="",x="Luminex Response (MFI-bg)",y="Density") +
  theme_minimal()+
  theme(
    strip.text.x = element_text(size=9),
    strip.text.y=element_text(size=12,angle=0),
    axis.title.y=element_text(color="gray40"),
    axis.text.y=element_text(color="gray60"),
    # panel.grid.minor.y = element_blank(),
    legend.position="none"
  )

p2

ggsave("~/enterics-immuno-epi/figs/kongwa-ab-distributions-byage.pdf",plot=p2,device="pdf",width=18,height=6)

```

#Comparison of seropositivity cutoffs

This part of the analysis identifies seropositive individuals based on ROC cutoffs (if available) and mixture distribution cutoffs (if available).  In cases where both cutoffs are available (_Giardia_,  and _E. histolytica_), we summarize the number of discordant measurements.  

```{r seropositivity}
dl <- dl %>%
  mutate(posroc = ifelse(logmfi > log10(roccut),1,0),
         posmix = ifelse(logmfi > mixcut,1,0))

# compare classification by ROC and mixture models 
# for Giardia and E. histolytica, the 2 pathogens
# with both
dcomp <- dl %>%
  filter(age==1) %>%
  filter(antigen %in% c("vsp3","leca")) %>% 
  mutate(antigen=factor(antigen))


dclass <- foreach(ab=levels(dcomp$antigen),.combine=rbind) %do% {
  dcompi <- dcomp %>% filter(antigen==ab)
  tabi <- as.vector(table(dcompi$posroc,dcompi$posmix))
  names(tabi) <- c("roc0mix0","roc1mix0","roc0mix1","roc1mix1")
  kappai <- psych::cohen.kappa(table(dcompi$posroc,dcompi$posmix))$kappa
  tabi <- data.frame(t(tabi))
  tabi <- tabi %>%
    mutate(Nobs=roc0mix0+roc1mix0+roc0mix1+roc1mix1,
           discordance=(roc1mix0+roc0mix1)/Nobs,
           agreement=(roc0mix0+roc1mix1)/Nobs,
           kappa=kappai,
           antigen=ab) %>%
    select(antigen,Nobs,everything())
  tabi
}

knitr::kable(dclass,digits=2,caption="Summary of seropositivity classifications by ROC curve and Gaussian mixture models for Giardia (VSP-3) and E. histolytica (LecA)")


```

```{r save data}
#-----------------------------
# save an updated dataset
# that includes cutoff values
# and seropositive indicators
#-----------------------------
saveRDS(dl,file="~/enterics-immuno-epi/data/kongwa_analysis2.rds")

```

# Session Info
```{r session info}
sessionInfo()
```

