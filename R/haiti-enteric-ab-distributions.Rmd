---
title: "Haiti enteric antibody distributions and seropositivity cutoffs"
output: 
  html_notebook:
    theme: default
    highlight: haddock
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: true
---

# Summary

This script summarizes the distribution of antibody responses in the Leogane, Haiti cohort. 

It fits Gaussian mixture models to the distributions, and where possible, estimates seropositivity cutoffs based on the mixture model fits.

For Giardia, Cryptosporidium, and E. histolytica antigens, the CDC lab estimated cutoff values using a receiver operator characteristic (ROC) curve approach with known positive and negative specimens. For these antigens, the script compares the classification of measurements by cutoff values derived from ROC and mixture models.

# Script preamble
```{r preamble}
#-----------------------------
# preamble
#-----------------------------
rm(list=ls())
library(tidyverse)
library(mixtools)

# set up for parallel computing
# configure for a laptop (use only 3 cores)
library(foreach)
library(doParallel)
registerDoParallel(cores=3)

# bright color blind palette:  https://personal.sron.nl/~pault/ 
cblack <- "#000004FF"
cblue <- "#3366AA"
cteal <- "#11AA99"
cgreen <- "#66AA55"
cchartr <- "#CCCC55"
cmagent <- "#992288"
cred <- "#EE3333"
corange <- "#EEA722"
cyellow <- "#FFEE33"
cgrey <- "#777777"

```


#Load the formatted data

```{r data format}
#-----------------------------
# load the formatted data
# created with 
# haiti-enteric-ab-data-format.Rmd
#-----------------------------
dl <- readRDS("~/enterics-immuno-epi/data/haiti_analysis.rds")

# list the enteric antigens and formatted labels for them
mbavars <- c("vsp3","vsp5","cp17","cp23","leca","etec","salb","sald","norogi","norogii")

mbalabs <- c("Giardia VSP-3","Giardia VSP-5","Cryptosporidium Cp17","Cryptosporidium Cp23","E. histolytica LecA","ETEC toxin beta subunit","Salmonella LPS B","Salmonella LPS D","Norovirus GI", "Norovirus GII")
```

#Distribution of antibody levels

```{r Ab distribution figure, fig.height=12, fig.width=6}

# custom color blind color palette is in the preamble chunck
pcols <- c(cred,corange,cgreen,cteal,cblue,cmagent)

# custom log labels
log10labs <- c( 
  expression(10^0),
  expression(10^1),
  expression(10^2),
  expression(10^3),
  expression(10^4)
)

p <- ggplot(data=dl,aes(x=logmfi,group=pathogen,color=pathogen,fill=pathogen)) +
  facet_wrap(~antigenf,nrow=6,ncol=2,scales="free_y") +
  # geom_histogram(aes(y=..density..),bins=50,alpha=0.7) +
  geom_density(aes(y=..density..),color=NA,alpha=0.7)+
  scale_x_continuous(limits = c(0,4.5),breaks = 0:4,labels=log10labs) +
  scale_fill_manual(values=pcols) +
  scale_color_manual(values=pcols) +
  labs(x="Luminex Response (MFI-bg)",y="Density") +
  theme_minimal(base_size=16) +
  theme(legend.position = "none")

p

# save a PDF version
ggsave("~/enterics-immuno-epi/figs/haiti-ab-distributions.pdf",plot=p,device="pdf",width=7,height=14)

```

#Seropositivity cutoff values 

## ROC cutoff values
Add ROC cutoffs from out-of-sample analysis of known positive and negative specimens. Previously published in Moss et al. 2014 AJTMH.
```{r roc cutoffs, echo=TRUE, message=FALSE, warning=FALSE}
#----------------------------
# Add ROC cutoffs 
# Estimated by Jeff Priest
# in Moss et al. 2014 Table 1
#----------------------------
dl$roccut <- NA
dl$roccut[dl$antigen %in% 'leca'] <- 302
dl$roccut[dl$antigen %in% 'cp17'] <- 180 
dl$roccut[dl$antigen %in% 'cp23'] <- 500 
dl$roccut[dl$antigen %in% 'vsp1'] <- 209 
dl$roccut[dl$antigen %in% 'vsp2'] <- 270 
dl$roccut[dl$antigen %in% 'vsp3'] <- 262
dl$roccut[dl$antigen %in% 'vsp4'] <- 209
dl$roccut[dl$antigen %in% 'vsp5'] <- 206 
```

## Mixture model cutoff estimation
Estimate cutoffs using 2-component Gaussian mixture models, fit with maximum likelihood.
```{r mixture densities, echo=TRUE, message=FALSE, warning=FALSE}

#-----------------------------
# mixture models
# fit among children 0-1 years
#-----------------------------
fitmix <- function(x,lambda,k) {
  mixfit <- normalmixEM(x,lambda=lambda,k=k)
  mixcut <- mixfit$mu[order(mixfit$mu)][1]+3*mixfit$sigma[order(mixfit$mu)][1]
  cat(summary(mixfit),"\nCutoff value:",mixcut,"(log10 MFI), or:",
      round(10^mixcut),"(MFI)\n\n")
  # pull out fitted densities
  denmat <- matrix(NA,nrow=length(x),ncol=k)
  denord <- order(mixfit$mu)
  for(i in 1:k) {
    j <- denord[i]
    denmat[,i] <- mixfit$lambda[j] * dnorm(x,mean=mixfit$mu[j],sd=mixfit$sigma[j])
  }
  denmat <- data.frame(denmat)
  colnames(denmat) <- paste("den",1:k,sep="")
  # return original values plus fitted densities in a dataframe 
  # also return the cutoff value and normalmixEM object
  xden <- data.frame(x=x,denmat)
  list(xden=xden,mixcut=mixcut,mixfit=mixfit)
  
}


## mixture model fits
# store densities of mixture distributions
# and estimated cutoffs
# set seed for perfect reproducibility due to
# some unstable estimates in  mixture fits
mixdens <- foreach(ab=mbavars,.combine=rbind) %do% {
  cat("\n\n Mixture model fit for ",ab,"\n\n")
  set.seed(2)
  mixf <- fitmix(x=dl$logmfi[dl$antigen==ab & dl$age<=1],lambda=0.5,k=2)
  di <- mixf$xden
  di$mixcut <- mixf$mixcut
  di$antigen=ab
  di <- di %>% arrange(x) %>% select(antigen,mixcut,everything())
  di
}

mixcuts <- mixdens %>%
  group_by(antigen) %>% filter(row_number()==1) %>% select(antigen,mixcut) %>% ungroup()

# Distribution for ETEC does not allow for reasonable mixture cutoffs
mixcuts$mixcut[mixcuts$antigen %in% c("etec")] <- NA

#-----------------------------
# merge in the mixture cutoffs
# to the main dataset
#-----------------------------
dl <- left_join(dl,mixcuts,by=c("antigen"))

```
Figure of antibody mixture distributions

```{r Ab mixture distribution figure, fig.height=12, fig.width=6}

# Get the mixture density distributions
# set the pathogen field to an arbitrary value (Giardia) to 
# mesh with the global ggplot aesthetics
plotmixdens <- mixdens %>%
  mutate(antigenf=factor(antigen,levels=mbavars,labels=mbalabs),
         pathogen="Giardia"
         )

# custom color blind color palette (pcols)
# and custom log10 labels (log10labs)
# defined in a previous code chunk

pmix <- ggplot(data=filter(dl,age<=1),aes(x=logmfi,group=pathogen,color=pathogen,fill=pathogen)) +
  facet_wrap(~antigenf,nrow=6,ncol=2,scales="free_y") +
  # plot empirical distribution and smooth
  # geom_histogram(aes(y=..density..),bins=50,alpha=0.7) +
  geom_density(aes(y=..density..),color=NA,alpha=0.7)+
  # plot fitted mixture distributions
  geom_line(data=plotmixdens,aes(x=x,y=den1),color=cblack) +
  # geom_line(data=plotmixdens,aes(x=x,y=den2),color=cblack) +
  # add vertical lines for the cutoff values
  geom_vline(aes(xintercept=log10(roccut))) +
  geom_vline(aes(xintercept=mixcut),linetype=2) +
  # labels and formatting
  scale_x_continuous(limits = c(0,4.5),breaks = 0:4,labels=log10labs) +
  coord_cartesian(ylim=c(0,2)) +
  labs(x="Luminex Response (MFI-bg)") +
  scale_fill_manual(values=pcols) +
  scale_color_manual(values=pcols) +
  theme_minimal(base_size = 16) +
  theme(legend.position = "none")

pmix

# save a PDF version
ggsave("~/enterics-immuno-epi/figs/haiti-ab-mixture-distributions.pdf",plot=pmix,device="pdf",width=7,height=14)

```

## Cutoffs derived from presumed unexposed
Children under age 2 years whose antibody levels increased by at least 2 on the log10 scale were presumably unexposed at their first measurement. Use them to identify an unexposed distribution.

```{r distribution among unexposed}
#-----------------------------
# calculate the change in
# log10 MFI values between
# measurements
#-----------------------------
dl <- dl %>%
  group_by(id,antigen) %>%
  mutate(logmfidiff = lead(logmfi) - logmfi) %>%
  mutate(unexp = ifelse(age<=1 & logmfidiff>=2,"Presumed unexposed","Possibly exposed"))

#-----------------------------
# subset the data to 
# measurements where the child
# was < 2 years old and the
# change in MFI was >= 2
#-----------------------------
dlunexp <- dl %>%
  filter(unexp=="Presumed unexposed")


#-----------------------------
# calculate the mean and SD
# of each distribution
#-----------------------------
unexp_dists <- dlunexp %>%
  group_by(pathogen,antigen,antigenf) %>%
  summarize(n = n(),
            unexp_mean = mean(logmfi),
            unexp_sd = sd(logmfi),
            unexpcut = unexp_mean + 3*unexp_sd) %>%
  ungroup()
#-----------------------------
# print values
#-----------------------------
select(unexp_dists,antigenf,n,starts_with("unexp"))


#-----------------------------
# merge the cutoff values
# based on presumed unexposed
# back to the main data
#-----------------------------
dlunexp2 <- unexp_dists %>%
  ungroup() %>%
  select(antigen,unexpcut)

dl <- left_join(dl,dlunexp2,by="antigen")




```
## Figure of distributions and cutoffs from presumed unexposed
```{r unexposed distribution figure, fig.height=12, fig.width=6}
#-----------------------------
# create a figure of the
# unexposed distributions
#-----------------------------
pcols <- c(cred,corange,cgreen,cteal,cblue,cmagent)
punexp <- ggplot(data=filter(dl,unexp=="Presumed unexposed" & !is.na(unexpcut)), aes(x=logmfi,group=pathogen,color=pathogen,fill=pathogen)) +
  facet_wrap(~antigenf,nrow=6,ncol=2,scales="free_y") +
  # plot empirical smoothed distribution
  geom_density(aes(y=..density..),color=NA,alpha=0.7)+
  # add vertical lines for the cutoff values
  geom_vline(aes(xintercept=log10(roccut))) +
  geom_vline(aes(xintercept=mixcut),linetype=2) +
  geom_vline(aes(xintercept=unexpcut),linetype=3) + 
  # labels and formatting
  scale_x_continuous(limits = c(0,4.5),breaks = 0:4,labels=log10labs) +
  coord_cartesian(ylim=c(0,2)) +
  labs(x="Luminex Response (MFI-bg)") +
  scale_fill_manual(values=pcols) +
  scale_color_manual(values=pcols) +
  theme_minimal(base_size = 16) +
  theme(legend.position = "none")

punexp

# save a PDF version
ggsave("~/enterics-immuno-epi/figs/haiti-ab-unexposed-distributions.pdf",plot=punexp,device="pdf",width=7,height=14)

```

## Figure of age-stratified antibody distributions, with cutoffs

```{r age stratified distribution figure, fig.width=12,fig.height=6}
dl <- dl %>%
  mutate(agecat = cut(age,breaks=c(0,1,2,3,12),
                      labels=c("0 years","1 year","2 years","3-11 years"))
         )

# custom color blind color palette is in the preamble chunck
pcols <- c(cred,corange,cgreen,cteal,cblue,cmagent)

# custom log labels
log10labs <- c( 
  expression(10^0),
  expression(10^1),
  expression(10^2),
  expression(10^3),
  expression(10^4)
)

# faceted over age and antigen
p2 <- ggplot(data=dl,aes(x=logmfi,fill=pathogen,color=pathogen)) +
  facet_grid(agecat~antigenf,scales='free')+
  geom_density(aes(y=..density..),color=NA,alpha=0.7)+
  geom_vline(aes(xintercept = log10(roccut))) +
  geom_vline(aes(xintercept = mixcut),linetype=2) +
  geom_vline(aes(xintercept=unexpcut),linetype=3) + 
  # scale_y_continuous(expand=c(0,0),breaks=seq(0,40,by=10)) +
  coord_cartesian(ylim=c(0, 1.25))+
  scale_x_continuous(expand=c(0,0),limits=c(0,5),breaks=0:4,labels=log10labs) +
  # scale_y_continuous(expand=c(0,0),breaks=c(0,0.5,1,1.5),labels=c("0","","1","")) +
  scale_fill_manual(values=pcols,guide_legend(title="Age category"))+
  labs(title="",x="Luminex Response (MFI-bg)",y="Density") +
  theme_minimal()+
  theme(
    strip.text.x = element_text(size=9),
    strip.text.y=element_text(size=12,angle=0),
    axis.title.y=element_text(color="gray40"),
    axis.text.y=element_text(color="gray60"),
    # panel.grid.minor.y = element_blank(),
    legend.position="none"
  )

p2

ggsave("~/enterics-immuno-epi/figs/haiti-ab-distributions-byage.pdf",plot=p2,device="pdf",width=16,height=6)

```

## Figure of age-stratified antibody densities, with cutoffs

This figure includes that same information as the figure in the last section, but in a more compact format, overlaying smooth density distributions in the same panel. Doesn't look as good as the previous plot 

```{r age stratified distribution figure2, fig.width=6,fig.height=12}

# custom color blind color palette is in the preamble chunck
# pcols <- c(cred,corange,cgreen,cteal,cblue,cmagent)
pcols <- c(cred,corange,cgreen,cblue)


# custom log labels
log10labs <- c( 
  expression(10^0),
  expression(10^1),
  expression(10^2),
  expression(10^3),
  expression(10^4)
)

p2den <- ggplot(data=dl,aes(x=logmfi,fill=agecat,color=agecat,group=agecat)) +
  facet_wrap(~antigenf,nrow=6,ncol=2,scales='free_y')+
  geom_density(aes(y=..density..),fill=NA)+
  # stat_density(geom="line") +
  geom_vline(aes(xintercept = log10(roccut))) +
  geom_vline(aes(xintercept = mixcut),linetype=2) +
  geom_vline(aes(xintercept=unexpcut),linetype=3) + 
  # scale_y_continuous(expand=c(0,0),breaks=seq(0,40,by=10)) +
  coord_cartesian(ylim=c(0, 1.25))+
  scale_x_continuous(expand=c(0,0),limits=c(0,5),breaks=0:4,labels=log10labs) +
  # scale_y_continuous(expand=c(0,0),breaks=c(0,0.5,1,1.5),labels=c("0","","1","")) +
  scale_color_manual(values=pcols,guide_legend(title="Age category"))+
  labs(title="",x="Luminex Response (MFI-bg)",y="Density") +
  theme_minimal()+
  theme(
    strip.text.x = element_text(size=9),
    strip.text.y=element_text(size=12,angle=0),
    axis.title.y=element_text(color="gray40"),
    axis.text.y=element_text(color="gray60"),
    # panel.grid.minor.y = element_blank(),
    legend.position="top"
  )

p2den

ggsave("~/enterics-immuno-epi/figs/haiti-ab-distributions-byage-compact.pdf",plot=p2den,device="pdf",width=7,height=14)


```


#Comparison of seropositivity cutoffs

This part of the analysis identifies seropositive individuals based on ROC cutoffs (if available) and mixture distribution cutoffs (if available).  In cases where both cutoffs are available (_Giardia_ and _Cryptosporidium_), we summarize the number of discordant measurements.  The results are mainly consistent between the two approaches, particularly for _Cryptosporidium_. Later seropositivity analyses rely on the mixture model cutoffs to be consistent across pathogens.

```{r seropositivity}
dl <- dl %>%
  mutate(posroc  = ifelse(logmfi > log10(roccut),1,0),
         posmix  = ifelse(logmfi > mixcut,1,0),
         posunex = ifelse(logmfi > unexpcut,1,0))
```


```{r seropositivity roc vs mix}
# compare classification by ROC and mixture models 
# for Giardia and Cryptosporidium, the 2 pathogens
# with both
dcomp <- dl %>%
  ungroup() %>%
  filter(age<=1) %>%
  filter(antigen %in% c("vsp3","vsp5","cp17","cp23","leca")) %>% 
  mutate(antigen=factor(antigen))


dclass <- foreach(ab=levels(dcomp$antigen),.combine=rbind) %do% {
  dcompi <- dcomp %>% filter(antigen==ab)
  tabi <- as.vector(table(dcompi$posroc,dcompi$posmix))
  names(tabi) <- c("roc0mix0","roc1mix0","roc0mix1","roc1mix1")
  kappai <- psych::cohen.kappa(table(dcompi$posroc,dcompi$posmix))$kappa
  tabi <- data.frame(t(tabi))
  tabi <- tabi %>%
    mutate(Nobs=roc0mix0+roc1mix0+roc0mix1+roc1mix1,
           discordance=(roc1mix0+roc0mix1)/Nobs,
           agreement=(roc0mix0+roc1mix1)/Nobs,
           kappa=kappai,
           antigen=ab) %>%
    select(antigen,Nobs,everything())
  tabi
}

knitr::kable(dclass,digits=2,caption="Summary of seropositivity classifications by ROC curve and Gaussian mixture models for Giardia (VSP-3 and VSP-5), Cryptosporidium (Cp17, Cp23), and E. histolytica (LecA")


```

```{r seropositivity roc vs unexp}
dcomp <- dl %>%
  ungroup() %>%
  filter(age<=1) %>%
  filter(antigen %in% c("vsp3","vsp5","cp17","cp23","leca")) %>% 
  mutate(antigen=factor(antigen))


dclass2 <- foreach(ab=levels(dcomp$antigen),.combine=rbind) %do% {
  dcompi <- dcomp %>% filter(antigen==ab)
  tabi <- as.vector(table(dcompi$posroc,dcompi$posunex))
  names(tabi) <- c("roc0unexp0","roc1unexp0","roc0unexp1","roc1unexp1")
  kappai <- psych::cohen.kappa(table(dcompi$posroc,dcompi$posunex))$kappa
  tabi <- data.frame(t(tabi))
  tabi <- tabi %>%
    mutate(Nobs=roc0unexp0+roc1unexp0+roc0unexp1+roc1unexp1,
           discordance=(roc1unexp0+roc0unexp1)/Nobs,
           agreement=(roc0unexp0+roc1unexp1)/Nobs,
           kappa=kappai,
           antigen=ab) %>%
    select(antigen,Nobs,everything())
  tabi
}

knitr::kable(dclass2,digits=3,caption="Summary of seropositivity classifications by ROC curve and distribution among unexposed for Giardia (VSP-3 and VSP-5), Cryptosporidium (Cp17, Cp23), and E. histolytica (LecA)")

```
```{r seropositivity mix vs unexp}
#-----------------------------
# compare classification by mixture
# model and distribution among the unexposed
# for Giardia, Crypto, E. hist,
# Salmonella, Noro GI and GII
# the pathogens with both
#-----------------------------
dcomp <- dl %>%
  ungroup() %>%
  filter(age<=1) %>%
  filter(antigen %in% c("vsp3","vsp5","cp17","cp23","leca","salb","sald","norogi","norogii")) %>% 
  mutate(antigen=factor(antigen))


dclass3 <- foreach(ab=levels(dcomp$antigen),.combine=rbind) %do% {
  dcompi <- dcomp %>% filter(antigen==ab)
  tabi <- as.vector(table(dcompi$posmix,dcompi$posunex))
  names(tabi) <- c("mix0unexp0","mix1unexp0","mix0unexp1","mix1unexp1")
  kappai <- psych::cohen.kappa(table(dcompi$posmix,dcompi$posunex))$kappa
  tabi <- data.frame(t(tabi))
  tabi <- tabi %>%
    mutate(Nobs=mix0unexp0+mix1unexp0+mix0unexp1+mix1unexp1,
           discordance=(mix1unexp0+mix0unexp1)/Nobs,
           agreement=(mix0unexp0+mix1unexp1)/Nobs,
           kappa=kappai,
           antigen=ab) %>%
    select(antigen,Nobs,everything())
  tabi
}

knitr::kable(dclass3,digits=3,caption="Summary of seropositivity classifications by Gaussian mixture model and distribution among unexposed for Giardia (VSP-3 and VSP-5), Cryptosporidium (Cp17, Cp23), E. histolytica (LecA), Salmonella (LPS D and LPS B), and Norovirus (Groups I and II)")
```


```{r save data}
#-----------------------------
# save an updated dataset
# that includes cutoff values
# and seropositive indicators
#-----------------------------
saveRDS(dl,file="~/enterics-immuno-epi/data/haiti_analysis2.rds")

```

# Session Info
```{r session info}
sessionInfo()
```

