---
title: "Kongwa enteric antibody analysis of age-dependent antibody curves"
output: 
  html_notebook:
    theme: default
    highlight: haddock
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: true
---

#Summary
This script estimates age-dependent mean antibody curves using cubic splines (in a GAM model from the `mgcv` package) and using ensemble machine learning (using super learning from the `tmleAb` package). 

# Script preamble
```{r preamble}
#-----------------------------
# preamble
#-----------------------------
rm(list=ls())
library(tidyverse)
library(kableExtra) # devtools::install_github("haozhu233/kableExtra")
library(mixtools)

options(knitr.table.format = "html") 

# set up for parallel computing
# configure for a laptop (use only 3 cores)
library(foreach)
library(doParallel)
registerDoParallel(cores=3)

# bright color blind palette:  https://personal.sron.nl/~pault/ 
cblack <- "#000004FF"
cblue <- "#3366AA"
cteal <- "#11AA99"
cgreen <- "#66AA55"
cchartr <- "#CCCC55"
cmagent <- "#992288"
cred <- "#EE3333"
corange <- "#EEA722"
cyellow <- "#FFEE33"
cgrey <- "#777777"

```


#Load the formatted data

```{r load data}
#-----------------------------
# load the formatted data
# with seropositivity indicators
# created with:
# kongwa-enteric-ab-data-format.Rmd -->
# kongwa-enteric-ab-distributions.Rmd
#-----------------------------
dl <- readRDS("~/enterics-immuno-epi/data/kongwa_analysis2.rds")

# list the enteric antigens and formatted labels for them
mbavars <- c("vsp3","vsp5","cp17","cp23","leca","salb","sald","p18","p39","etec","cholera")

mbalabs <- c("Giardia VSP-3","Giardia VSP-5","Cryptosporidium Cp17","Cryptosporidium Cp23",
             "E. histolytica LecA","Campylobacter p18","Campylobacter p39","ETEC toxin beta subunit","Cholera toxin beta subunit","Salmonella LPS B","Salmonella LPS D")
```

#Estimate age-dependent mean antibody levels

##Estimate curves using splines in a generalized additive model (GAM)

```{r age-curve mean gam }
#----------------------------------
# simulataneous CIs for GAMs
# estimated by resampling the 
# Baysian posterior estimates of
# the variance-covariance matrix
# assuming that it is multivariate normal
# the function below also estimates 
# the unconditional variance-covariance
# matrix, Vb=vcov(x,unconditional=TRUE), 
# which allows for undertainty in the actual
# estimated mean as well 
# (Marra & Wood 2012 Scandinavian Journal of Statistics, 
#  Vol. 39: 53â€“74, 2012, doi: 10.1111/j.1467-9469.2011.00760.x )
# simultaneous CIs provide much better coverage than pointwise CIs
# see: http://www.fromthebottomoftheheap.net/2016/12/15/simultaneous-interval-revisited/
#----------------------------------

gamCI <- function(m,newdata,nreps=10000) {
  require(mgcv)
  require(dplyr)
  Vb <- vcov(m,unconditional = TRUE)
  pred <- predict(m, newdata, se.fit = TRUE)
  fit <- pred$fit
  se.fit <- pred$se.fit
  BUdiff <- MASS::mvrnorm(n=nreps, mu = rep(0, nrow(Vb)), Sigma = Vb)
  Cg <- predict(m, newdata, type = "lpmatrix")
  simDev <- Cg %*% t(BUdiff)
  absDev <- abs(sweep(simDev, 1, se.fit, FUN = "/"))
  masd <- apply(absDev, 2L, max)
  crit <- quantile(masd, prob = 0.95, type = 8)
  pred <- data.frame(newdata,fit=pred$fit,se.fit=pred$se.fit)
  pred <- mutate(pred,
                 uprP = fit + (2 * se.fit),
                 lwrP = fit - (2 * se.fit),
                 uprS = fit + (crit * se.fit),
                 lwrS = fit - (crit * se.fit)
  )
  return(pred)
}


# fit cubic spline over age, separately for each antigen
# estimate approximate simultaneous confidence intervals
# for the fits
library(mgcv)
gamfits <- foreach(ab=levels(dl$antigenf),.combine=rbind) %dopar% {
    pd <- filter(dl, antigenf==ab)
    gfit <- gam(logmfi~s(age, bs="cr",k=9),data=pd)
    gsci <- gamCI(m=gfit,newdata=pd,nreps=1000)
    gsci$antigen <- ab
    return(gsci)
  }
```

##Estimate curves using ensemble machine learning
```{r age-curve mean ensemble, echo=TRUE, message=FALSE, warning=FALSE}
#-----------------------------
# estimate curves with 
# ensemble machine learning
# including a library with
# GLM, GAM, Loess, and 
# extreme gradient boosting
#-----------------------------

# detach the mgcv package because
# the ensemble algorithm uses gam()
# from the gam package and there are
# conflicts between them
detach("package:mgcv", unload=TRUE)

# load the tmleAb package, at this time
# only available through github: 
# devtools::install_github("ben-arnold/tmleAb")
library(tmleAb)
set.seed(123)
slfits <-  foreach(ab=levels(dl$antigenf),.combine=rbind) %dopar% {
  pd <- filter(dl, antigenf==ab)
  slfit <- agecurveAb(Y=pd$logmfi,
                      Age=pd$age,
                      id=pd$id,
                      SL.library = c("SL.glm","SL.gam","SL.loess","SL.xgboost"))
  sld <- data.frame(age=slfit$Age,fit=slfit$pY)
  sld <- sld %>% group_by(age) %>% filter(row_number()==1) %>% ungroup()
  slres <- left_join(pd,sld,by=c("age"))
  return(slres)
}

#-----------------------------
# estimate means by age in 
# years (1-9)
# to get 95% CIs through the
# influence curve
#-----------------------------

tmlemeans <- foreach(ab=levels(dl$antigenf),.combine=rbind) %:%
  foreach(agei=1:9,.combine=rbind) %dopar% {
    pd <- filter(dl,antigenf==ab & floor(age)==agei)
    mu <- tmleAb(Y=pd$logmfi,id=pd$clusterid,SL.library="SL.mean")
    di <- data.frame(pathogen=pd$pathogen[1],antigenf=ab,age=agei,mean=mu$psi,se=mu$se,lb=mu$lb,ub=mu$ub)
    di
  }


```

##Plot age-dependent mean antibody curves

Plot all of the estimates together. The spline fits are colored and the highly adaptive ensemble fits are grey. Empirical means with 95% CIs (averaged by year) are black. The approximate simultaneous confidence bands for the spline fit are shaded. All of the plots shift the age in years completed by 0.5, assuming they are uniformly distributed between rounded values.

```{r age-curve mean figure all, fig.height=12, fig.width=6}

log10labs <- c( 
  expression(10^0),
  expression(10^1),
  expression(10^2),
  expression(10^3),
  expression(10^4)
)

# custom color blind color palette is in the preamble chunck
pcols <- c(cred,corange,cgreen,cteal,cteal,cblue,cgrey)

pcurveall <- ggplot(data=gamfits,aes(x=age+0.5,group=pathogen,color=pathogen,fill=pathogen)) +
  # approximate simultaneous CI from spline fit
  geom_ribbon(aes(ymin=lwrS,ymax=uprS),alpha=0.2,color=NA,fill=cgrey) +
  # actual measurements
  # geom_jitter(aes(y=logmfi),width=0.2,height=0,color="black",alpha=0.4,size=0.3) +
  # ensemble fit
  geom_line(data=slfits,aes(x=age+0.5,y=fit),color=cgrey) +
  # spline fit
  geom_line(aes(y=fit)) +
  # empirical means 95% CI from the influence curve (averaged for each age)
  geom_pointrange(data=tmlemeans,aes(x=age+0.5,y=mean,ymin=lb,ymax=ub),size=0.2,color=cblack)+
  # plot aesthetics
  facet_wrap(~antigenf,nrow=6,ncol=2) +
  scale_x_continuous(limits=c(0,9),breaks=seq(0,8,by=2))+
  scale_y_continuous(breaks=0:4,labels=log10labs)+
  coord_cartesian(ylim=c(0,4.5))+
  labs(x="Age in years",y="Luminex Response (MFI-bg)") +
  scale_fill_manual(values=pcols) +
  scale_color_manual(values=pcols) +
  theme_minimal() +
  theme(legend.position = "none")

pcurveall

# save a PDF version 
ggsave("~/enterics-immuno-epi/figs/kongwa-ab-agecurves-mean-allestimates.pdf",plot=pcurveall,device="pdf",width=7,height=14)

```


Create a more parsimonius plot, that only includes the spline fits but also includes the actual points.
```{r age-curve mean figure, fig.height=12, fig.width=6}

log10labs <- c( 
  expression(10^0),
  expression(10^1),
  expression(10^2),
  expression(10^3),
  expression(10^4)
)

# custom color blind color palette is in the preamble chunck
pcols <- c(cred,corange,cgreen,cteal,cteal,cblue,cgrey)

pcurve <- ggplot(data=gamfits,aes(x=age+0.5,group=pathogen,color=pathogen,fill=pathogen)) +
  # approximate simultaneous CI from spline fit
  geom_ribbon(aes(ymin=lwrS,ymax=uprS),alpha=0.2,color=NA,fill=cgrey) +
  # actual measurements
  geom_jitter(aes(y=logmfi),width=0.2,height=0,color="black",alpha=0.3,size=0.3) +
  # ensemble fit
  # geom_line(data=slfits,aes(x=age,y=fit),color=cgrey) +
  # spline fit
  geom_line(aes(y=fit)) +
  # plot aesthetics
  facet_wrap(~antigenf,nrow=6,ncol=2) +
  scale_x_continuous(limits=c(0,10),breaks=seq(0,10,by=2))+
  scale_y_continuous(breaks=0:4,labels=log10labs)+
  coord_cartesian(ylim=c(0,4.5))+
  labs(x="Age in years",y="Luminex Response (MFI-bg)") +
  scale_fill_manual(values=pcols) +
  scale_color_manual(values=pcols) +
  theme_minimal() +
  theme(legend.position = "none")

pcurve

# save a PDF version 
ggsave("~/enterics-immuno-epi/figs/kongwa-ab-agecurves-mean.pdf",plot=pcurve,device="pdf",width=7,height=14)

```


#Estimate age-dependent seroprevalence

##Estimate seroprevalence curves using splines in a generalized additive model (GAM)

```{r age-curve seroprevalence gam }

#-----------------------------
# subset the data to antigens
# with seropositivity estimates
# In Tanzania, due to the older
# age of the cohort, the only
# antigens that have reliable
# cutoff values are those with
# ROC cutoffs

#-----------------------------
dlp <- dl %>%
  mutate(seropos=ifelse(!is.na(posroc),posroc,posmix),
         serocut=ifelse(!is.na(posroc),log10(roccut),mixcut),
         serocut_desc=ifelse(!is.na(posroc),"ROC","Mixture Model")) %>%
  filter(!is.na(seropos))

#-----------------------------
# estimate seroprevalence curves with 
# splines
#-----------------------------

# fit cubic spline over age, separately for each antigen
# estimate approximate simultaneous confidence intervals
# for the fits
library(mgcv)
pgamfits <- foreach(ab=c("vsp3","vsp5","cp17","cp23","leca"),.combine=rbind) %dopar% {
    pd <- filter(dlp, antigen==ab)
    gfit <- mgcv::gam(seropos~s(age, bs="cr",k=9),data=pd,family="binomial")
    gsci <- gamCI(m=gfit,newdata=pd,nreps=1000)
    gsci$antigen <- ab
    return(gsci)
}

# use antilogit to get back to prevalence from the logit link
pgamfits <- pgamfits %>%
  mutate(fit  = 1/(1+exp(-fit)),
         uprP = 1/(1+exp(-uprP)),
         lwrP = 1/(1+exp(-lwrP)),
         uprS = 1/(1+exp(-uprS)),
         lwrS = 1/(1+exp(-lwrS))) %>%
  mutate(antigenf=factor(antigen,levels=mbavars,labels=mbalabs))

```

##Estimate seroprevalence curves using ensemble machine learning
```{r age-curve seroprevalence ensemble, echo=TRUE, message=FALSE, warning=FALSE}
#-----------------------------
# estimate curves with 
# ensemble machine learning
# including a library with
# GLM, GAM, Loess, and 
# extreme gradient boosting
#-----------------------------

# detach the mgcv package because
# the ensemble algorithm uses gam()
# from the gam package and there are
# conflicts between them
detach("package:mgcv", unload=TRUE)

set.seed(12345)
pslfits <-  foreach(ab=c("vsp3","vsp5","cp17","cp23","leca"),.combine=rbind) %dopar% {
  pd <- filter(dlp, antigen==ab)
  slfit <- agecurveAb(Y=pd$seropos,
                      Age=pd$age,
                      id=pd$id,
                      family="binomial",
                      SL.library = c("SL.glm","SL.gam","SL.xgboost"))
  sld <- data.frame(age=slfit$Age,fit=slfit$pY)
  sld <- sld %>% group_by(age) %>% filter(row_number()==1) %>% ungroup()
  slres <- left_join(pd,sld,by=c("age"))
  return(slres)
}


#-----------------------------
# estimate means by age in 
# years (1-9)
# to get 95% CIs through the
# influence curve
#-----------------------------

tmlemeansp <- foreach(ab=c("Giardia VSP-3","Giardia VSP-5","Cryptosporidium Cp17","Cryptosporidium Cp23","E. histolytica LecA"),.combine=rbind) %:%
  foreach(agei=1:9,.combine=rbind) %dopar% {
    pd <- filter(dlp,antigenf==ab & floor(age)==agei)
    mu <- tmleAb(Y=pd$seropos,id=pd$clusterid,SL.library="SL.mean")
    di <- data.frame(pathogen=pd$pathogen[1],antigenf=ab,age=agei,mean=mu$psi,se=mu$se,lb=mu$lb,ub=mu$ub)
    di
  }

```

##Plot age-dependent seroprevalence  curves

Plot all of the estimates together. The spline fits are colored and the highly adaptive ensemble fits are grey. Empirical means with 95% CIs (averaged by year) are black. The approximate simultaneous confidence bands for the spline fit are shaded. Ages are shifted by 0.5 years because in the Kongwa study ages are years completed (e.g., an individual age 1 could be anywhere from 1.0 to 1.9 years old, and 1.5 is approximately unbiased).

```{r age-curve seroprevalence figure all, fig.height=9, fig.width=6}

# bright color-blind palette defined in an earlier code chunk
pcols <- c(cred,corange,cgreen,cteal,cblue,cmagent)

ppcurve <- ggplot(data=pgamfits,aes(x=age+0.5,group=pathogen,color=pathogen,fill=pathogen)) +
  # approximate simultaneous CI from spline fit
  geom_ribbon(aes(ymin=lwrS,ymax=uprS),alpha=0.2,color=NA,fill=cgrey) +
  # actual measurements
  # geom_jitter(aes(y=posmix),width=0.2,height=0,color="black",alpha=0.4,size=0.3) +
   # ensemble fit
  geom_line(data=pslfits,aes(x=age+0.5,y=fit),color=cgrey) +
  # spline fit
  geom_line(aes(y=fit)) +
  # empirical means 95% CI from the influence curve (averaged for each age)
  geom_pointrange(data=tmlemeansp,aes(x=age+0.5,y=mean,ymin=lb,ymax=ub),size=0.2,color=cblack)+
  # plot aesthetics
  facet_wrap(~antigenf,nrow=6,ncol=2) +
  scale_x_continuous(limits=c(0,10),breaks=seq(0,10,by=2))+
  scale_y_continuous(breaks=seq(0,1,by=0.2),labels=sprintf("%1.0f",seq(0,1,by=0.2)*100))+
  coord_cartesian(ylim=c(0,1))+
  labs(x="Age in years",y="Seroprevalence (%)") +
  scale_fill_manual(values=pcols) +
  scale_color_manual(values=pcols) +
  theme_minimal() +
  theme(legend.position = "none")

ppcurve

# save a PDF version
ggsave("~/enterics-immuno-epi/figs/kongwa-ab-agecurves-seroprev-allests.pdf",plot=ppcurve,device="pdf",width=7,height=14)

```

Create a more parsimonius plot, that only includes the spline fits. For the seroprevalence data, it doesn't look very good to include the points because there are so many observations that even when transparent they don't display any variation in density by age.

```{r age-curve seroprevalence figure, fig.height=9, fig.width=6}


# bright color-blind palette defined in an earlier code chunk
pcols <- c(cred,corange,cgreen,cteal,cblue,cmagent)

ppcurve2 <- ggplot(data=pgamfits,aes(x=age+0.5,group=pathogen,color=pathogen,fill=pathogen)) +
  # approximate simultaneous CI from spline fit
  geom_ribbon(aes(ymin=lwrS,ymax=uprS),alpha=0.2,color=NA,fill=cgrey) +
  # actual measurements
  # geom_jitter(aes(y=seropos),width=0.2,height=0,color="black",alpha=0.4,size=0.3) +
  # spline fit
  geom_line(aes(y=fit)) +
  # plot aesthetics
  facet_wrap(~antigenf,nrow=6,ncol=2) +
  scale_x_continuous(limits=c(0,10),breaks=seq(0,10,by=2))+
  scale_y_continuous(breaks=seq(0,1,by=0.2),labels=sprintf("%1.0f",seq(0,1,by=0.2)*100))+
  coord_cartesian(ylim=c(0,1))+
  labs(x="Age in years",y="Seroprevalence (%)") +
  scale_fill_manual(values=pcols) +
  scale_color_manual(values=pcols) +
  theme_minimal() +
  theme(legend.position = "none")

ppcurve2

# save a PDF version
ggsave("~/enterics-immuno-epi/figs/kongwa-ab-agecurves-seroprev.pdf",plot=ppcurve2,device="pdf",width=7,height=14)

```

## Numerical seroprevalence estimates to report in the manuscript. 


```{r seroprev numerical estimates}
# grab predicted means from cubic splines very close to each year of age
pests <- pgamfits %>%
  mutate(agey = floor(age)) %>%
  filter(age+0.02 > agey & age-0.02 < agey) %>%
  group_by(antigenf) %>%
  filter(!duplicated(agey)) %>%
  arrange(antigenf,agey) %>%
  select(antigenf,agey,prev=fit,prev_min95=lwrS,prev_max95=uprS)

pests


```

# Save fitted estimates for later use
```{r save estimates}
# spline fits of geometric means
saveRDS(gamfits,file="~/enterics-immuno-epi/output/kongwa-enteric-ab-gamfits-means.rds")
# ensemble fits of geometric means
saveRDS(slfits,file="~/enterics-immuno-epi/output/kongwa-enteric-ab-slfits-means.rds")
# spline fits of age-dependent seroprevalence
saveRDS(pgamfits,file="~/enterics-immuno-epi/output/kongwa-enteric-ab-gamfits-seroprev.rds")
# spline fits of age-dependent seroprevalence
saveRDS(pslfits,file="~/enterics-immuno-epi/output/kongwa-enteric-ab-slfits-seroprev.rds")
```

# Session Info
```{r session info}
sessionInfo()
```

