---
title: "Asembo enteric antibody distributions and seropositivity cutoffs"
output: 
  html_notebook:
    theme: default
    highlight: haddock
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: true
---

# Summary

This script summarizes the distribution of antibody responses in the Asembo cohort. 

It fits Gaussian mixture models to the distributions, and where possible, estimates seropositivity cutoffs based on the mixture model fits.

For Giardia and Cryptosporidium antigens, the CDC lab estimated cutoff values using a receiver operator characteristic (ROC) curve approach with known positive and negative specimens. For these antigens, the script compares the classification of measurements by cutoff values derived from ROC and mixture models.

# Script preamble
```{r preamble}
#-----------------------------
# preamble
#-----------------------------
rm(list=ls())
library(tidyverse)
library(mixtools)

# set up for parallel computing
# configure for a laptop (use only 3 cores)
library(foreach)
library(doParallel)
registerDoParallel(cores=3)

# bright color blind palette:  https://personal.sron.nl/~pault/ 
cblack <- "#000004FF"
cblue <- "#3366AA"
cteal <- "#11AA99"
cgreen <- "#66AA55"
cchartr <- "#CCCC55"
cmagent <- "#992288"
cred <- "#EE3333"
corange <- "#EEA722"
cyellow <- "#FFEE33"
cgrey <- "#777777"

```


#Load the formatted data

```{r data format}
#-----------------------------
# load the formatted data
# created with 
# asembo-enteric-ab-data-format.Rmd
#-----------------------------
dl <- readRDS("~/enterics-immuno-epi/data/asembo_analysis.rds")

# list the enteric antigens and formatted labels for them
mbavars <- c("vsp3","vsp5","cp17","cp23","leca","rotavirus","p18","p39","etec","cholera")

mbalabs <- c("Giardia VSP-3","Giardia VSP-5","Cryptosporidium Cp17","Cryptosporidium Cp23",
             "E. histolytica LecA","Rotavirus","Campylobacter p18","Campylobacter p39","ETEC toxin beta subunit","Cholera toxin beta subunit")
```

#Distribution of antibody levels

```{r Ab distribution figure, fig.height=12, fig.width=6}

# custom color blind color palette is in the preamble chunck
pcols <- c(cred,corange,cchartr,cgreen,cteal,cblue,cmagent)

# custom log labels
log10labs <- c( 
  expression(10^0),
  expression(10^1),
  expression(10^2),
  expression(10^3),
  expression(10^4)
)

p <- ggplot(data=dl,aes(x=logmfi,group=pathogen,color=pathogen,fill=pathogen)) +
  facet_wrap(~antigenf,nrow=5,ncol=2,scales="free_y") +
  geom_histogram(aes(y=..density..),bins=50,alpha=0.7) +
  geom_density(aes(fill=NULL),color=cgrey) +
  scale_x_continuous(limits = c(0,4.5),breaks = 0:4,labels=log10labs) +
  scale_fill_manual(values=pcols) +
  scale_color_manual(values=pcols) +
  labs(x="Luminex Response (MFI-bg)") +
  theme_minimal(base_size=16) +
  theme(legend.position = "none")

p

# save a PDF version
ggsave("~/dropbox/asembo/results/figs/asembo-ab-distributions.pdf",plot=p,device="pdf",width=7,height=14)

```

#Seropositivity cutoff values 

```{r mixture densities, echo=TRUE, results="hide", message=FALSE, warning=FALSE}
#-----------------------------
# add cutoff values for
# those with an ROC cutoff
#-----------------------------
dl$roccut <- NA
dl$roccut[dl$antigen %in% "vsp3"] <- 542
dl$roccut[dl$antigen %in% "vsp5"] <- 421
dl$roccut[dl$antigen %in% "cp17"] <- 375
dl$roccut[dl$antigen %in% "cp23"] <- 1336

#-----------------------------
# mixture models
#-----------------------------
fitmix <- function(x,lambda,k) {
  mixfit <- normalmixEM(x,lambda=lambda,k=k)
  mixcut <- mixfit$mu[order(mixfit$mu)][1]+3*mixfit$sigma[order(mixfit$mu)][1]
  cat(summary(mixfit),"\nCutoff value:",mixcut,"(log10 MFI), or:", round(10^mixcut),"(MFI)\n\n")
  # pull out fitted densities
  denmat <- matrix(NA,nrow=length(x),ncol=k)
  for(i in 1:k) {
    denmat[,i] <- mixfit$lambda[i] * dnorm(x,mean=mixfit$mu[i],sd=mixfit$sigma[i])
  }
  denmat <- data.frame(denmat)
  colnames(denmat) <- paste("den",1:k,sep="")
  # return original values plus fitted densities in a dataframe 
  # also return the cutoff value and normalmixEM object
  xden <- data.frame(x=x,denmat)
  list(xden=xden,mixcut=mixcut,mixfit=mixfit)
  
}

## mixture model fits
# store densities of mixture distributions
# and estimated cutoffs
mixdens <- foreach(ab=mbavars,.combine=rbind) %do% {
  cat("\n\n Mixture model fit for ",ab,"\n\n")
  mixf <- fitmix(x=dl$logmfi[dl$antigen==ab],lambda=0.5,k=2)
  di <- mixf$xden
  di$mixcut <- mixf$mixcut
  di$antigen=ab
  di <- di %>% arrange(x) %>% select(antigen,mixcut,everything())
  di
}

mixcuts <- mixdens %>%
  group_by(antigen) %>% filter(row_number()==1) %>% select(antigen,mixcut) %>% ungroup()

# Distributions for p18,ETEC and Cholera do not allow for reasonable mixture cutoffs
mixcuts$mixcut[mixcuts$antigen %in% c("p18","etec","cholera")] <- NA

#-----------------------------
# merge in the mixture cutoffs
# to the main dataset
#-----------------------------
dl <- left_join(dl,mixcuts,by=c("antigen"))

```

## Figure of antibody mixture distributions

```{r Ab mixture distribution figure, fig.height=12, fig.width=6}

# Get the mixture density distributions
# Distributions for p18, ETEC and Cholera did not have reasonable
# fits to set them to missing
# set the pathogen field to an arbitrary value (Giardia) to 
# mesh with the global ggplot aesthetics
plotmixdens <- mixdens %>%
  mutate(den1p = ifelse(antigen %in% c("p18","etec","cholera"),NA,den1),
         den2p = ifelse(antigen %in% c("p18","etec","cholera"),NA,den2)
         ) %>%
  mutate(antigenf=factor(antigen,levels=mbavars,labels=mbalabs),
         pathogen="Giardia"
         )

# custom color blind color palette (pcols)
# and custom log10 labels (log10labs)
# defined in a previous code chunk

pmix <- ggplot(data=dl,aes(x=logmfi,group=pathogen,color=pathogen,fill=pathogen)) +
  facet_wrap(~antigenf,nrow=5,ncol=2,scales="free_y") +
  # plot empirical distribution and smooth
  geom_histogram(aes(y=..density..),bins=50,alpha=0.7) +
  geom_density(aes(fill=NULL),color=cgrey) +
  # plot fitted mixture distributions
  geom_line(data=plotmixdens,aes(x=x,y=den1p),color=cblack) +
  geom_line(data=plotmixdens,aes(x=x,y=den2p),color=cblack) +
  # add vertical lines for the cutoff values
  geom_vline(aes(xintercept=log10(roccut))) +
  geom_vline(aes(xintercept=mixcut),linetype=2) +
  # labels and formatting
  scale_x_continuous(limits = c(0,4.5),breaks = 0:4,labels=log10labs) +
  coord_cartesian(ylim=c(0,2)) +
  labs(x="Luminex Response (MFI-bg)") +
  scale_fill_manual(values=pcols) +
  scale_color_manual(values=pcols) +
  theme_minimal(base_size = 16) +
  theme(legend.position = "none")

pmix

# save a PDF version
ggsave("~/dropbox/asembo/results/figs/asembo-ab-mixture-distributions.pdf",plot=pmix,device="pdf",width=7,height=14)

```

#Comparison of seropositivity cutoffs

This part of the analysis identifies seropositive individuals based on ROC cutoffs (if available) and mixture distribution cutoffs (if available).  In cases where both cutoffs are available (_Giardia_ and _Cryptosporidium_), we summarize the number of discordant measurements.  The results are mainly consistent between the two approaches, particularly for _Cryptosporidium_. Later seropositivity analyses rely on the mixture model cutoffs to be consistent across pathogens.

```{r seropositivity}
dl <- dl %>%
  mutate(posroc = ifelse(logmfi > log10(roccut),1,0),
         posmix = ifelse(logmfi > mixcut,1,0))

# compare classification by ROC and mixture models 
# for Giardia and Cryptosporidium, the 2 pathogens
# with both
dcomp <- dl %>%
  filter(antigen %in% c("vsp3","vsp5","cp17","cp23")) %>% 
  mutate(antigen=factor(antigen))


dclass <- foreach(ab=levels(dcomp$antigen),.combine=rbind) %do% {
  dcompi <- dcomp %>% filter(antigen==ab)
  tabi <- as.vector(table(dcompi$posroc,dcompi$posmix))
  names(tabi) <- c("roc0mix0","roc1mix0","roc0mix1","roc1mix1")
  tabi <- data.frame(t(tabi))
  tabi <- tabi %>%
    mutate(Nobs=roc0mix0+roc1mix0+roc0mix1+roc1mix1,
           discordance=(roc1mix0+roc0mix1)/Nobs,
           antigen=ab) %>%
    select(antigen,Nobs,everything())
  tabi
}

knitr::kable(dclass,digits=2,caption="Summary of seropositivity classifications by ROC curve and Gaussian mixture models for Giardia (VSP-3 and VSP-5) and Cryptosporidium (Cp17, Cp23)")


```

```{r save data}
#-----------------------------
# save an updated dataset
# that includes cutoff values
# and seropositive indicators
#-----------------------------
saveRDS(dl,file="~/enterics-immuno-epi/data/asembo_analysis2.rds")

```

# Session Info
```{r session info}
sessionInfo()
```

